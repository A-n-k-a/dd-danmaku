// @copyright    2022, RyoLee (https://github.com/RyoLee)
// @license      MIT; https://raw.githubusercontent.com/RyoLee/emby-danmaku/master/LICENSE
(async function(){"use strict";let requireDanmakuPath="https://danmaku.7o7o.cc/danmaku.min.js",corsProxy="https://ddplay-api.7o7o.cc/cors/";const openSourceLicense={self:{version:"1.40",name:"Emby Danmaku Extension(Based on 1.11)",license:"MIT License",url:"https://github.com/chen3861229/dd-danmaku"},original:{version:"1.11",name:"Emby Danmaku Extension",license:"MIT License",url:"https://github.com/RyoLee/emby-danmaku"},jellyfinFork:{version:"1.45",name:"Jellyfin Danmaku Extension",license:"MIT License",url:"https://github.com/Izumiko/jellyfin-danmaku"},danmaku:{version:"2.0.6",name:"Danmaku",license:"MIT License",url:"https://github.com/weizhenye/Danmaku"},danmakuFork:{version:"v1.2.1",name:"Danmaku(Based on 2.0.6)",license:"MIT License",url:"https://github.com/lanytcc/Danmaku"},dandanplayApi:{version:"v2",name:"弹弹 play API",license:"MIT License",url:"https://github.com/kaedei/dandanplay-libraryindex"},bangumiApi:{version:"2024-10-15",name:"Bangumi API",license:"None",url:"https://github.com/bangumi/api"}},dandanplayApi={prefix:corsProxy+"https://api.dandanplay.net/api/v2",getSearchEpisodes:(e,t)=>`${dandanplayApi.prefix}/search/episodes?anime=${e}${t?`&episode=${t}`:""}`,getComment:(e,t)=>`${dandanplayApi.prefix}/comment/${e}?withRelated=true&chConvert=${t}`,getExtcomment:e=>`${dandanplayApi.prefix}/extcomment?url=${encodeURI(e)}`,getBangumi:e=>`${dandanplayApi.prefix}/bangumi/${e}`,posterImg:e=>`https://img.dandanplay.net/anime/${e}.jpg`},bangumiApi={prefix:"https://api.bgm.tv/v0",accessTokenUrl:"https://next.bgm.tv/demo/access-token",getCharacters:e=>`${bangumiApi.prefix}/subjects/${e}/characters`,getMyself:()=>`${bangumiApi.prefix}/me`,postUserCollection:e=>`${bangumiApi.prefix}/users/-/collections/${e}`,getUserSubjectEpisodeCollection:e=>`${bangumiApi.prefix}/users/-/collections/${e}/episodes?offset=0&limit=100`,putUserEpisodeCollection:e=>`${bangumiApi.prefix}/users/-/collections/-/episodes/${e}`},check_interval=200,LOAD_TYPE={CHECK:"check",INIT:"init",REFRESH:"refresh",RELOAD:"reload",SEARCH:"search"};let isVersionOld=!1,mediaContainerQueryStr=".graphicContentContainer";const notHide=":not(.hide)",mediaQueryStr="video",iconKeys={replay_30:"replay_30",replay_10:"replay_10",replay_5:"replay_5",replay:"replay",reset:"repeat",forward_media:"forward_media",forward_5:"forward_5",forward_10:"forward_10",forward_30:"forward_30",comment:"comment",comments_disabled:"comments_disabled",switch_on:"toggle_on",switch_off:"toggle_off",setting:"tune",search:"search",done:"done_all",done_disabled:"remove_done",more:"more_horiz",close:"close",refresh:"refresh",block:"block",text_format:"translate",person:"person",sentiment_very_satisfied:"sentiment_very_satisfied",check:"check"},currentDanmakuInfoContainerId="danmakuTab2",tabIframeId="danmakuTab5",danmakuTabOpts=[{id:"danmakuTab0",name:"弹幕设置",buildMethod:buildDanmakuSetting},{id:"danmakuTab1",name:"手动匹配",buildMethod:buildSearchEpisode},{id:currentDanmakuInfoContainerId,name:"弹幕信息",buildMethod:buildCurrentDanmakuInfo},{id:"danmakuTab3",name:"高级设置",buildMethod:buildProSetting},{id:"danmakuTab4",name:"关于",buildMethod:buildAbout},{id:tabIframeId,name:"内嵌网页",hidden:!0,buildMethod:buildIframe}],danmakuTypeFilterOpts={bottom:{id:"bottom",name:"底部弹幕"},top:{id:"top",name:"顶部弹幕"},ltr:{id:"ltr",name:"从左至右"},rtl:{id:"rtl",name:"从右至左"},rolling:{id:"rolling",name:"滚动弹幕"},onlyWhite:{id:"onlyWhite",name:"彩色弹幕"}},danmakuSource={AcFun:{id:"AcFun",name:"A站(AcFun)"},BiliBili:{id:"BiliBili",name:"B站(BiliBili)"},DanDanPlay:{id:"DanDanPlay",name:"弹弹(DanDanPlay)"},D:{id:"D",name:"D"},Gamer:{id:"Gamer",name:"巴哈(Gamer)"},iqiyi:{id:"iqiyi",name:"爱奇艺(iqiyi)"},QQ:{id:"QQ",name:"腾讯视频(QQ)"},Youku:{id:"Youku",name:"优酷(Youku)"},"5dm":{id:"5dm",name:"D站(5dm)"},"异世界动漫":{id:"异世界动漫",name:"异世界动漫"}},showSource={source:{id:"source",name:"来源平台"},originalUserId:{id:"originalUserId",name:"用户ID"},cid:{id:"cid",name:"弹幕CID"}},danmakuEngineOpts=[{id:"canvas",name:"canvas"},{id:"dom",name:"dom"}],danmakuChConverOpts=[{id:"0",name:"未启用"},{id:"1",name:"转换为简体"},{id:"2",name:"转换为繁体"}],embyOffsetBtnStyle="margin: 0;padding: 0;",timeOffsetBtns=[{label:"-30",valueOffset:"-30",iconKey:iconKeys.replay_30,style:embyOffsetBtnStyle},{label:"-10",valueOffset:"-10",iconKey:iconKeys.replay_10,style:embyOffsetBtnStyle},{label:"-5",valueOffset:"-5",iconKey:iconKeys.replay_5,style:embyOffsetBtnStyle},{label:"-1",valueOffset:"-1",iconKey:iconKeys.replay,style:embyOffsetBtnStyle},{label:"0",valueOffset:"0",iconKey:iconKeys.reset,style:embyOffsetBtnStyle},{label:"+1",valueOffset:"1",iconKey:iconKeys.replay,style:embyOffsetBtnStyle+" transform: rotateY(180deg);"},{label:"+5",valueOffset:"5",iconKey:iconKeys.forward_5,style:embyOffsetBtnStyle},{label:"+10",valueOffset:"10",iconKey:iconKeys.forward_10,style:embyOffsetBtnStyle},{label:"+30",valueOffset:"30",iconKey:iconKeys.forward_30,style:embyOffsetBtnStyle}],toastPrefixes={system:"[系统通知] : "},hasToastPrefixes=(e,t)=>Object.values(t).some((t=>e.text.startsWith(t))),getDanmakuComments=e=>e.danmaku?.comments.filter((e=>!hasToastPrefixes(e,toastPrefixes)))??[],danmuListOpts=[{id:"0",name:"不启用",onChange:()=>[]},{id:"1",name:"屏中",onChange:e=>e.danmaku._.runningList},{id:"2",name:"所有",onChange:e=>e.commentsParsed},{id:"3",name:"已加载",onChange:getDanmakuComments},{id:"4",name:"被过滤",onChange:e=>e.commentsParsed.filter((t=>!getDanmakuComments(e).some((e=>t.cuid===e.cuid))))},{id:"5",name:"通知",onChange:e=>e.danmaku.comments.filter((e=>hasToastPrefixes(e,toastPrefixes)))}],timeoutCallbackUnitOpts=[{id:"0",name:"秒",msRate:1e3},{id:"1",name:"分",msRate:6e4},{id:"2",name:"时",msRate:36e5}];let timeoutCallbackId;const timeoutCallbackClear=()=>timeoutCallbackId&&clearTimeout(timeoutCallbackId),timeoutCallbackTypeOpts=[{id:"0",name:"不启用",onChange:()=>timeoutCallbackClear()},{id:"1",name:"退出播放",onChange:e=>{timeoutCallbackClear(),timeoutCallbackId=setTimeout((()=>{closeEmbyDialog(),Emby.InputManager.trigger("back")}),e)}},{id:"2",name:"返回主页",onChange:e=>{timeoutCallbackClear(),timeoutCallbackId=setTimeout((()=>{closeEmbyDialog(),Emby.Page.goHome()}),e)}}],getApiTl=e=>e.toString().match(/\=>\s*(.*)$/)[1].trim().replace(/`/g,""),lsKeys={chConvert:{id:"danmakuChConvert",defaultValue:1,name:"简繁转换"},switch:{id:"danmakuSwitch",defaultValue:!0,name:"弹幕开关"},filterLevel:{id:"danmakuFilterLevel",defaultValue:0,name:"过滤强度"},heightPercent:{id:"danmakuHeightPercent",defaultValue:100,name:"显示区域"},fontSizeRate:{id:"danmakuFontSizeRate",defaultValue:1,name:"弹幕大小"},fontOpacity:{id:"danmakuFontOpacity",defaultValue:1,name:"透明度"},speed:{id:"danmakuBaseSpeed",defaultValue:1,name:"速度"},fontWeight:{id:"danmakuFontWeight",defaultValue:400,name:"弹幕粗细"},fontStyle:{id:"danmakuFontStyle",defaultValue:0,name:"弹幕斜体"},timelineOffset:{id:"danmakuTimelineOffset",defaultValue:0,name:"轴偏秒"},danmuList:{id:"danmakuDanmuList",defaultValue:0,name:"弹幕列表"},typeFilter:{id:"danmakuTypeFilter",defaultValue:[],name:"屏蔽类型"},sourceFilter:{id:"danmakuSourceFilter",defaultValue:[],name:"屏蔽来源平台"},showSource:{id:"danmakuShowSource",defaultValue:[],name:"显示每条来源"},engine:{id:"danmakuEngine",defaultValue:"canvas",name:"弹幕引擎"},filterKeywords:{id:"danmakuFilterKeywords",defaultValue:"",name:"屏蔽关键词"},filterKeywordsEnable:{id:"danmakuFilterKeywordsEnable",defaultValue:!0,name:"屏蔽关键词启用"},timeoutCallbackUnit:{id:"danmakuTimeoutCallbackUnit",defaultValue:1,name:"定时单位"},timeoutCallbackValue:{id:"danmakuTimeoutCallbackValue",defaultValue:0,name:"定时值"},bangumiEnable:{id:"danmakuBangumiEnable",defaultValue:!1,name:"启用并填写个人令牌"},bangumiToken:{id:"danmakuBangumiToken",defaultValue:"",name:"个人令牌"},bangumiPostPercent:{id:"danmakuBangumiPostPercent",defaultValue:95,name:"时长比"},consoleLogEnable:{id:"danmakuConsoleLogEnable",defaultValue:!1,name:"控制台日志"},osdTitleEnable:{id:"danmakuOsdTitleEnable",defaultValue:!1,name:"播放界面右下角显示弹幕信息"},osdLineChartEnable:{id:"danmakuOsdLineChartEnable",defaultValue:!1,name:"进度条上显示弹幕每秒内数量折线图"},debugShowDanmakuWrapper:{id:"danmakuDebugShowDanmakuWrapper",defaultValue:!1,name:"弹幕容器边界"},debugShowDanmakuCtrWrapper:{id:"danmakuDebugShowDanmakuCtrWrapper",defaultValue:!1,name:"按钮容器边界"},debugReverseDanmu:{id:"danmakuDebugReverseDanmu",defaultValue:!1,name:"反转弹幕方向"},debugRandomDanmuColor:{id:"danmakuDebugRandomDanmuColor",defaultValue:!1,name:"随机弹幕颜色"},debugForceDanmuWhite:{id:"danmakuDebugForceDanmuWhite",defaultValue:!1,name:"强制弹幕白色"},debugGenerateLarge:{id:"danmakuDebugGenerateLarge",defaultValue:!1,name:"测试大量弹幕"},debugDialogHyalinize:{id:"danmakuDebugDialogHyalinize",defaultValue:!1,name:"透明弹窗背景"},debugTabIframeEnable:{id:"danmakuDebugTabIframeEnable",defaultValue:!1,name:"打开内嵌网页"},quickDebugOn:{id:"danmakuQuickDebugOn",defaultValue:!1,name:"快速调试"},customeCorsProxyUrl:{id:"danmakuCustomeCorsProxyUrl",defaultValue:corsProxy,name:"跨域代理前缀"},customeDanmakuUrl:{id:"danmakuCustomeDanmakuUrl",defaultValue:requireDanmakuPath,name:"弹幕引擎依赖"},customeGetCommentUrl:{id:"danmakuCustomeGetCommentUrl",defaultValue:getApiTl(dandanplayApi.getComment),name:"获取指定弹幕库的所有弹幕"},customeGetExtcommentUrl:{id:"danmakuCustomeGetExtcommentUrl",defaultValue:getApiTl(dandanplayApi.getExtcomment),name:"获取指定第三方url的弹幕"},customePosterImgUrl:{id:"danmakuCustomePosterImgUrl",defaultValue:getApiTl(dandanplayApi.posterImg),name:"媒体海报"}},eleIds={danmakuSwitchBtn:"danmakuSwitchBtn",danmakuCtr:"danmakuCtr",danmakuWrapper:"danmakuWrapper",h5VideoAdapter:"h5VideoAdapter",dialogContainer:"dialogContainer",danmakuSwitchDiv:"danmakuSwitchDiv",danmakuSwitch:"danmakuSwitch",filterLevelDiv:"filterLevelDiv",filterLevelLabel:"filterLevelLabel",danmakuSearchNameDiv:"danmakuSearchNameDiv",danmakuSearchName:"danmakuSearchName",danmakuEpisodeFlag:"danmakuEpisodeFlag",danmakuAnimeDiv:"danmakuAnimeDiv",danmakuSwitchEpisode:"danmakuSwitchEpisode",danmakuEpisodeNumDiv:"danmakuEpisodeNumDiv",danmakuEpisodeLoad:"danmakuEpisodeLoad",danmakuRemark:"danmakuRemark",danmakuAnimeSelect:"danmakuAnimeSelect",danmakuEpisodeNumSelect:"danmakuEpisodeNumSelect",searchImgDiv:"searchImgDiv",searchImg:"searchImg",extConmentSearchDiv:"extConmentSearchDiv",extUrlsDiv:"extUrlsDiv",currentMatchedDiv:"currentMatchedDiv",filteringDanmaku:"filteringDanmaku",danmakuTypeFilterDiv:"danmakuTypeFilterDiv",danmakuTypeFilterSelectName:"danmakuTypeFilterSelectName",danmakuSourceFilterDiv:"danmakuSourceFilterDiv",danmakuSourceFilterSelectName:"danmakuSourceFilterSelectName",danmakuShowSourceDiv:"danmakuShowSourceDiv",danmakuShowSourceSelectName:"danmakuShowSourceSelectName",posterImgDiv:"posterImgDiv",danmuListDiv:"danmuListDiv",danmuListText:"danmakuListText",extInfoCtrlDiv:"extInfoCtrlDiv",extInfoDiv:"extInfoDiv",characterImgHeihtDiv:"characterImgHeihtDiv",characterImgHeihtLabel:"characterImgHeihtLabel",charactersDiv:"charactersDiv",filterKeywordsDiv:"filterKeywordsDiv",danmakuChConverDiv:"danmakuChConverDiv",danmakuEngineDiv:"danmakuEngineDiv",heightPercentDiv:"heightPercentDiv",heightPercentLabel:"heightPercentLabel",danmakuSizeDiv:"danmakuSizeDiv",danmakuSizeLabel:"danmakuSizeLabel",danmakuOpacityDiv:"danmakuOpacityDiv",danmakuOpacityLabel:"danmakuOpacityLabel",danmakuSpeedDiv:"danmakuSpeedDiv",danmakuSpeedLabel:"danmakuSpeedLabel",danmakuFontWeightDiv:"danmakuFontWeightDiv",danmakuFontWeightLabel:"danmakuFontWeightLabel",danmakuFontStyleDiv:"danmakuFontStyleDiv",danmakuFontStyleLabel:"danmakuFontStyleLabel",timelineOffsetDiv:"timelineOffsetDiv",timelineOffsetLabel:"timelineOffsetLabel",settingsCtrl:"settingsCtrl",settingsText:"settingsText",settingsImportBtn:"settingsImportBtn",settingReloadBtn:"settingReloadBtn",filterKeywordsEnableId:"filterKeywordsEnableId",filterKeywordsId:"filterKeywordsId",timeoutCallbackDiv:"timeoutCallbackDiv",timeoutCallbackLabel:"timeoutCallbackLabel",timeoutCallbackTypeDiv:"timeoutCallbackTypeDiv",timeoutCallbackUnitDiv:"timeoutCallbackUnitDiv",bangumiEnableLabel:"bangumiEnableLabel",bangumiSettingsDiv:"bangumiSettingsDiv",bangumiTokenInput:"bangumiTokenInput",bangumiTokenInputDiv:"bangumiTokenInputDiv",bangumiTokenLabel:"bangumiTokenInputLabel",bangumiTokenLinkDiv:"bangumiTokenLinkDiv",bangumiPostPercentDiv:"bangumiPostPercentDiv",bangumiPostPercentLabel:"bangumiPostPercentLabel",customeUrlsDiv:"customeUrlsDiv",customeCorsProxyDiv:"customeCorsProxyDiv",customeDanmakuDiv:"customeDanmakuDiv",customeGetCommentDiv:"customeGetCommentDiv",customeGetExtcommentDiv:"customeGetExtcommentDiv",customePosterImgDiv:"customePosterImgDiv",consoleLogCtrl:"consoleLogCtrl",consoleLogInfo:"consoleLogInfo",consoleLogText:"consoleLogText",consoleLogTextInput:"consoleLogTextInput",consoleLogCountLabel:"consoleLogCountLabel",debugCheckbox:"debugCheckbox",debugButton:"debugButton",tabIframe:"tabIframe",tabIframeHeightDiv:"tabIframeHeightDiv",tabIframeHeightLabel:"tabIframeHeightLabel",tabIframeCtrlDiv:"tabIframeCtrlDiv",tabIframeSrcInputDiv:"tabIframeSrcInputDiv",openSourceLicenseDiv:"openSourceLicenseDiv",videoOsdDanmakuTitle:"videoOsdDanmakuTitle",extCheckboxDiv:"extCheckboxDiv",danmakuSettingBtnDebug:"danmakuSettingBtnDebug",progressBarLineChart:"progressBarLineChart"},mediaBtnOpts=[{id:eleIds.danmakuSwitchBtn,label:"弹幕开关",iconKey:iconKeys.comment,onClick:doDanmakuSwitch},{label:"弹幕设置",iconKey:iconKeys.setting,onClick:createDialog}],customeUrlMsg1="限弹弹 play API 兼容结构",customeUrl={init:()=>customeUrl.mapping.map((e=>e.rewrite(lsGetItem(e.lsKey.id)))),mapping:[{divId:eleIds.customeDanmakuDiv,lsKey:lsKeys.customeDanmakuUrl,rewrite:e=>{requireDanmakuPath=e},msg1:`限 ${openSourceLicense.danmaku.url} 兼容结构`,msg2:"Danmaku 依赖路径,index.html 引入的和篡改猴环境不会使用到,依赖已内置,\n                        仅在被 CustomCssJS 执行的特殊环境下使用,支持相对/绝对/网络路径,\n                        默认是相对路径等同 https://emby/web/ 和 /system/dashboard-ui/ ,非浏览器客户端必须使用网络路径"},{divId:eleIds.customeCorsProxyDiv,lsKey:lsKeys.customeCorsProxyUrl,rewrite:e=>{corsProxy=e},msg1:"仅弹弹 play API 跨域使用,限 URL 前缀反代方式,例如 cf_worker",msg2:"以下共用变量: { dandanplayApi.prefix: 反代前缀拼接的弹弹 play API 路径前缀, }"},{divId:eleIds.customeGetCommentDiv,lsKey:lsKeys.customeGetCommentUrl,rewrite:tl=>{dandanplayApi.getComment=(episodeId,chConvert)=>eval("`"+tl+"`")},msg1:customeUrlMsg1,msg2:"变量: { episodeId: 章节 ID, chConvert: 简繁转换, }"},{divId:eleIds.customeGetExtcommentDiv,lsKey:lsKeys.customeGetExtcommentUrl,rewrite:tl=>{dandanplayApi.getExtcomment=url=>eval("`"+tl+"`")},msg1:customeUrlMsg1,msg2:"变量: { url: 附加弹幕输入框中的网址, }"},{divId:eleIds.customePosterImgDiv,lsKey:lsKeys.customePosterImgUrl,rewrite:tl=>{dandanplayApi.posterImg=animeId=>eval("`"+tl+"`")},msg1:customeUrlMsg1,msg2:"变量: { animeId: 弹弹 play 的作品 ID, }"}]},classes={dialogContainer:"dialogContainer",dialogBackdropOpened:"dialogBackdropOpened",dialogBlur:"dialog-blur",dialog:"dialog",formDialogHeader:"formDialogHeader",formDialogFooter:"formDialogFooter",formDialogFooterItem:"formDialogFooterItem",videoOsdTitle:"videoOsdTitle",videoOsdBottomButtonsRight:"videoOsdBottom-buttons-right",videoOsdPositionSliderContainer:"videoOsdPositionSliderContainer",cardImageIcon:"cardImageIcon",headerRight:"headerRight",headerUserButton:"headerUserButton",mdlSpinner:"mdl-spinner",collapseContentNav:"collapseContent navDrawerCollapseContent",embyLabel:"inputLabel",embyInput:"emby-input emby-input-smaller",embySelectWrapper:"emby-select-wrapper emby-select-wrapper-smaller",embyCheckboxList:"featureList",embyFieldDesc:"fieldDescription",embyTabsMenu:"headerMiddle headerSection sectionTabs headerMiddle-withSectionTabs",embyTabsDiv1:"tabs-viewmenubar tabs-viewmenubar-backgroundcontainer focusable scrollX hiddenScrollX smoothScrollX scrollFrameX emby-tabs",embyTabsDiv2:"tabs-viewmenubar-slider emby-tabs-slider padded-left padded-right nohoverfocus scrollSliderX",embyTabsButton:"emby-button secondaryText emby-tab-button main-tab-button",embyButtons:{basic:"raised emby-button",submit:"button-submit",help:"button-help",link:"button-link",iconButton:"flex-shrink-zero paper-icon-button-light"}},styles={embyCheckboxList:"display: flex;flex-wrap: wrap;",embySliderList:"display: flex;flex-direction: column;justify-content: center;align-items: center;",embySlider:"display: flex; align-items: center; gap: 1em; margin-bottom: 0.3em;",colors:{info:16777215,success:65280,warn:16776960,error:16711680,highlight:"rgba(115, 160, 255, 0.3)",switchActiveColor:"#52b54b"},fontStyles:[{id:"normal",name:"正常"},{id:"italic",name:"原生斜体"},{id:"oblique",name:"形变斜体"}]},OS={isAndroid:()=>/android/i.test(navigator.userAgent),isIOS:()=>/iPad|iPhone|iPod/i.test(navigator.userAgent),isMacOS:()=>/Macintosh|MacIntel/i.test(navigator.userAgent),isApple:()=>OS.isMacOS()||OS.isIOS(),isWindows:()=>/compatible|Windows/i.test(navigator.userAgent),isMobile:()=>OS.isAndroid()||OS.isIOS(),isUbuntu:()=>/Ubuntu/i.test(navigator.userAgent),isAndroidEmbyNoisyX:()=>OS.isAndroid()&&ApiClient.appVersion().includes("-"),isEmbyNoisyX:()=>ApiClient.appVersion().includes("-"),isOthers:()=>Object.entries(OS).filter((([e,t])=>"isOthers"!==e)).every((([e,t])=>!t()))};let skipInnerModule=!1;try{throw new Error}catch(e){skipInnerModule=e.stack&&e.stack.includes("CustomCssJS")}var t,e;skipInnerModule?window.Danmaku||Emby.importModule(requireDanmakuPath).then((e=>{console.log(e),window.Danmaku=e})).catch((e=>{console.error("fail Emby.importModule error:",e)})):(t=this,e=function(){var e=function(){if("undefined"==typeof document)return"transform";for(var e=["oTransform","msTransform","mozTransform","webkitTransform","transform"],t=document.createElement("div").style,n=0;n<e.length;n++)if(e[n]in t)return e[n];return"transform"}();function t(e){var t=document.createElement("div");if(t.style.cssText="position:absolute;","function"==typeof e.render){var n=e.render();if(n instanceof HTMLElement)return t.appendChild(n),t}if(t.textContent=e.text,e.style)for(var i in e.style)t.style[i]=e.style[i];return t}var n={name:"dom",init:function(){var e=document.createElement("div");return e.style.cssText="overflow:hidden;white-space:nowrap;transform:translateZ(0);",e},clear:function(e){for(var t=e.lastChild;t;)e.removeChild(t),t=e.lastChild},resize:function(e,t,n){e.style.width=t+"px",e.style.height=n+"px"},framing:function(){},setup:function(e,n){var i=document.createDocumentFragment(),a=0,s=null;for(a=0;a<n.length;a++)(s=n[a]).node=s.node||t(s),i.appendChild(s.node);for(n.length&&e.appendChild(i),a=0;a<n.length;a++)(s=n[a]).width=s.width||s.node.offsetWidth,s.height=s.height||s.node.offsetHeight},render:function(t,n){n.node.style[e]="translate("+n.x+"px,"+n.y+"px)"},remove:function(e,t){e.removeChild(t.node),this.media||(t.node=null)}},i="undefined"!=typeof window&&window.devicePixelRatio||1,a=Object.create(null);function s(e,t){if("function"==typeof e.render){var n=e.render();if(n instanceof HTMLCanvasElement)return e.width=n.width,e.height=n.height,n}var s=document.createElement("canvas"),l=s.getContext("2d"),o=e.style||{};o.font=o.font||"10px sans-serif",o.textBaseline=o.textBaseline||"bottom";var d=1*o.lineWidth;for(var r in d=d>0&&d!==1/0?Math.ceil(d):1*!!o.strokeStyle,l.font=o.font,e.width=e.width||Math.max(1,Math.ceil(l.measureText(e.text).width)+2*d),e.height=e.height||Math.ceil(function(e,t){if(a[e])return a[e];var n=12,i=e.match(/(\d+(?:\.\d+)?)(px|%|em|rem)(?:\s*\/\s*(\d+(?:\.\d+)?)(px|%|em|rem)?)?/);if(i){var s=1*i[1]||10,l=i[2],o=1*i[3]||1.2,d=i[4];"%"===l&&(s*=t.container/100),"em"===l&&(s*=t.container),"rem"===l&&(s*=t.root),"px"===d&&(n=o),"%"===d&&(n=s*o/100),"em"===d&&(n=s*o),"rem"===d&&(n=t.root*o),void 0===d&&(n=s*o)}return a[e]=n,n}(o.font,t))+2*d,s.width=e.width*i,s.height=e.height*i,l.scale(i,i),o)l[r]=o[r];var m=0;switch(o.textBaseline){case"top":case"hanging":m=d;break;case"middle":m=e.height>>1;break;default:m=e.height-d}return o.strokeStyle&&l.strokeText(e.text,d,m),l.fillText(e.text,d,m),s}function l(e){return 1*window.getComputedStyle(e,null).getPropertyValue("font-size").match(/(.+)px/)[1]}var o={name:"canvas",init:function(e){var t=document.createElement("canvas");return t.context=t.getContext("2d"),t._fontSize={root:l(document.getElementsByTagName("html")[0]),container:l(e)},t},clear:function(e,t){e.context.clearRect(0,0,e.width,e.height);for(var n=0;n<t.length;n++)t[n].canvas=null},resize:function(e,t,n){e.width=t*i,e.height=n*i,e.style.width=t+"px",e.style.height=n+"px"},framing:function(e){e.context.clearRect(0,0,e.width,e.height)},setup:function(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.canvas=s(i,e._fontSize)}},render:function(e,t){e.context.drawImage(t.canvas,t.x*i,t.y*i)},remove:function(e,t){t.canvas=null}};function d(e){const t=this,n=t.media?t.media.currentTime:Date.now()/1e3,i=t.media?t.media.playbackRate:1,a=e.mode,s=e.height,l=t._.height,o=Math.floor(l/s);t._.space[a]&&t._.space[a].length===o||(t._.space[a]=new Array(o).fill(null).map((()=>({endTime:0}))));const d=t._.space[a];let r=-1;function m(e,t,n,i,a,s){if(!e||!e.endTime)return!0;if(n>=e.endTime)return!0;if("ltr"===a||"rtl"===a){const l=n-e.startTime,o=n-t.time,d=s._.duration/i,r=s._.width,m=l/d*r,c=o/d*r;let u=0,y=0,p=0,g=0;if("rtl"===a?(u=s._.width-m,y=u+e.width,p=s._.width-c,g=p+t.width):(y=-e.width+m,u=y-e.width,g=-t.width+c,p=g-t.width),p<y&&g>u||g>u&&p<y)return!1}if("top"===a||"bottom"===a){const t=s._.duration/i;return n-e.startTime>=t}return!0}for(let s=0;s<o;s++)if(m(d[s],e,n,i,a,t)){r=s;break}if(-1===r)return-1;const c=t.media?e.time:e._utc,u=c+t._.duration/i;return d[r]={startTime:c,endTime:u,width:e.width,height:e.height},"bottom"===a?l-(r+1)*s:r*s}var r="undefined"!=typeof window&&(window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame)||function(e){return setTimeout(e,50/3)},m="undefined"!=typeof window&&(window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame)||clearTimeout;function c(e,t,n){for(var i=0,a=0,s=e.length;a<s-1;)n>=e[i=a+s>>1][t]?a=i:s=i;return e[a]&&n<e[a][t]?a:s}function u(e){return/^(ltr|top|bottom)$/i.test(e)?e.toLowerCase():"rtl"}function y(e){e.ltr=[],e.rtl=[],e.top=[],e.bottom=[]}function p(){if(!this._.visible||!this._.paused)return this;if(this._.paused=!1,this.media)for(var e=0;e<this._.runningList.length;e++){var t=this._.runningList[e];t._utc=Date.now()/1e3-(this.media.currentTime-t.time)}var n=this,i=function(e,t,n,i){return function(a){let s=a;void 0===s&&(s=Date.now()),e(this._.stage);const l=s/1e3,o=this.media?this.media.currentTime:l,r=this.media?this.media.playbackRate:1;let m=null,c=0,u=0;for(u=this._.runningList.length-1;u>=0;u--){m=this._.runningList[u],c=this.media?m.time:m._utc;const e=(l-m._utc)*r;let t=!1;"top"===m.mode||"bottom"===m.mode?e>this._.duration&&(t=!0):"ltr"===m.mode?m.x>this._.width&&(t=!0):"rtl"===m.mode&&m.x+m.width<0&&(t=!0),t&&(i(this._.stage,m),this._.runningList.splice(u,1))}const y=[];for(;this._.position<this.comments.length&&(m=this.comments[this._.position],c=this.media?m.time:m._utc,!(c>=o));)o-c>this._.duration||(this.media&&(m._utc=l-(this.media.currentTime-m.time)),y.push(m)),++this._.position;for(t(this._.stage,y),u=0;u<y.length;u++)m=y[u],m.y=d.call(this,m),this._.runningList.push(m);for(u=0;u<this._.runningList.length;u++){if(m=this._.runningList[u],-1===m.y)continue;const e=(l-m._utc)*r/this._.duration,t=this._.width*e;"ltr"===m.mode?m.x=-m.width+t:"rtl"===m.mode?m.x=this._.width-t:"top"!==m.mode&&"bottom"!==m.mode||(m.x=(this._.width-m.width)/2),m.element&&m.element.style&&(m.element.style.transform=`translate(${m.x}px, ${m.y}px)`),n(this._.stage,m)}}}(this._.engine.framing.bind(this),this._.engine.setup.bind(this),this._.engine.render.bind(this),this._.engine.remove.bind(this));return this._.requestID=r((function e(){i.call(n),n._.requestID=r(e)})),this}function g(){return!this._.visible||this._.paused||(this._.paused=!0,m(this._.requestID),this._.requestID=0),this}function b(){if(!this.media)return this;this.clear(),y(this._.space);var e=c(this.comments,"time",this.media.currentTime);return this._.position=Math.max(0,e-1),this}function h(e){e.play=p.bind(this),e.pause=g.bind(this),e.seeking=b.bind(this),this.media.addEventListener("play",e.play),this.media.addEventListener("pause",e.pause),this.media.addEventListener("playing",e.play),this.media.addEventListener("waiting",e.pause),this.media.addEventListener("seeking",e.seeking)}function f(e){this.media.removeEventListener("play",e.play),this.media.removeEventListener("pause",e.pause),this.media.removeEventListener("playing",e.play),this.media.removeEventListener("waiting",e.pause),this.media.removeEventListener("seeking",e.seeking),e.play=null,e.pause=null,e.seeking=null}function v(e){this._={},this.container=e.container||document.createElement("div"),this.media=e.media,this._.visible=!0,this.engine=(e.engine||"DOM").toLowerCase(),this._.engine="canvas"===this.engine?o:n,this._.requestID=0,this._.speed=Math.max(0,e.speed)||144,this._.duration=4,this.comments=e.comments||[],this.comments.sort((function(e,t){return e.time-t.time}));for(var t=0;t<this.comments.length;t++)this.comments[t].mode=u(this.comments[t].mode);return this._.runningList=[],this._.position=0,this._.paused=!0,this.media&&(this._.listener={},h.call(this,this._.listener)),this._.stage=this._.engine.init(this.container),this._.stage.style.cssText+="position:relative;pointer-events:none;",this.resize(),this.container.appendChild(this._.stage),this._.space={},y(this._.space),this.media&&this.media.paused||(b.call(this),p.call(this)),this}function I(){if(!this.container)return this;for(var e in g.call(this),this.clear(),this.container.removeChild(this._.stage),this.media&&f.call(this,this._.listener),this)Object.prototype.hasOwnProperty.call(this,e)&&(this[e]=null);return this}var k=["mode","time","text","render","style"];function w(e){if(!e||"[object Object]"!==Object.prototype.toString.call(e))return this;for(var t={},n=0;n<k.length;n++)void 0!==e[k[n]]&&(t[k[n]]=e[k[n]]);if(t.text=(t.text||"").toString(),t.mode=u(t.mode),t._utc=Date.now()/1e3,this.media){var i=0;void 0===t.time?(t.time=this.media.currentTime,i=this._.position):(i=c(this.comments,"time",t.time))<this._.position&&(this._.position+=1),this.comments.splice(i,0,t)}else this.comments.push(t);return this}function S(){return this._.visible||(this._.visible=!0,this.media&&this.media.paused||(b.call(this),p.call(this))),this}function D(){return this._.visible?(g.call(this),this.clear(),this._.visible=!1,this):this}function C(){return this._.engine.clear(this._.stage,this._.runningList),this._.runningList=[],this}function x(){return this._.width=this.container.offsetWidth,this._.height=this.container.offsetHeight,this._.engine.resize(this._.stage,this._.width,this._.height),this._.duration=this._.width/this._.speed,this}var L={get:function(){return this._.speed},set:function(e){return"number"!=typeof e||isNaN(e)||!isFinite(e)||e<=0?this._.speed:(this._.speed=e,this._.width&&(this._.duration=this._.width/e),e)}};function E(e){e&&v.call(this,e)}return E.prototype.destroy=function(){return I.call(this)},E.prototype.emit=function(e){return w.call(this,e)},E.prototype.show=function(){return S.call(this)},E.prototype.hide=function(){return D.call(this)},E.prototype.clear=function(){return C.call(this)},E.prototype.resize=function(){return x.call(this)},Object.defineProperty(E.prototype,"speed",L),E},"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Danmaku=e());class EDE{constructor(){this.chConvert=lsGetItem(lsKeys.chConvert.id),this.danmaku=null,this.episode_info=null,this.ob=null,this.loading=!1,this.danmuCache={},this.commentsParsed=[],this.extConmentCache={},this.destroyIntervalIds=[],this.searchDanmakuOpts={},this.appLogAspect=null,this.bangumiInfo={}}}class AppLogAspect{constructor(){this.initialized=!1,this.originalError=console.error,this.originalWarn=console.warn,this.originalLog=console.log,this.originalOnerror=null,this.value="",this.listeners=[],this.ERROR={text:"ERROR",emoji:"❗️"},this.WARN={text:"WARN",emoji:"⚠️"},this.INFO={text:"INFO",emoji:"❕"}}init(){return this.initialized||(console.error=(...e)=>{this.originalError.apply(console,e),this.value+=this.format(this.ERROR,e),this.notifyListeners()},console.warn=(...e)=>{this.originalWarn.apply(console,e),this.value+=this.format(this.WARN,e),this.notifyListeners()},console.log=(...e)=>{this.originalLog.apply(console,e),this.value+=this.format(this.INFO,e),this.notifyListeners()},this.originalOnerror=window.onerror,window.onerror=(...e)=>{console.error(e),"function"==typeof this.originalOnerror&&this.originalOnerror(...e)},this.initialized=!0),this}destroy(e=!0){return this.initialized&&(console.error=this.originalError,console.warn=this.originalWarn,console.log=this.originalLog,window.onerror=this.originalOnerror,e&&(this.value=""),this.listeners=[],this.initialized=!1),this}format(e,t){const n=e.emoji?`[${e.emoji}] `:"";return`[${new Date(Date.now()).toLocaleString()}] [${e.text}] ${n}: `+t.map((e=>e instanceof Error?e.message:"string"==typeof e?e:JSON.stringify(e))).join(" ")+"\n"}on(e){if(e.toString().includes("console.log")||e.toString().includes("console.error"))throw new Error("The callback function must not contain console.log or console.error to avoid infinite loops.");this.listeners.push((()=>e(this.value)))}notifyListeners(){this.listeners.forEach((e=>e()))}clearValue(){this.value="",this.notifyListeners()}}function initListener(){const e=document.querySelector(mediaQueryStr);e?e.getAttribute("ede_listening")||(console.log("正在初始化Listener"),playbackEventsOn({playbackstart:(e,t)=>{loadDanmaku(LOAD_TYPE.INIT),console.log(e.type)}}),playbackEventsOn({playbackstop:onPlaybackStopped}),e.setAttribute("ede_listening",!0),document.addEventListener("video-osd-show",(e=>{console.log(e.type,e),lsGetItem(lsKeys.osdLineChartEnable.id)&&buildProgressBarChart(20)})),console.log("Listener初始化完成"),OS.isAndroidEmbyNoisyX()&&(console.log("检测为安卓小秘版,首次播放未触发 playbackstart 事件,手动初始化弹幕环境"),loadDanmaku(LOAD_TYPE.INIT))):window.ede.episode_info&&(window.ede.episode_info=null)}function initUI(){if(getById(eleIds.danmakuCtr))return;console.log("正在初始化UI"),parseFloat(ApiClient.serverVersion())<4.8&&(mediaContainerQueryStr='div[data-type="video-osd"]',isVersionOld=!0),mediaContainerQueryStr.includes(notHide)||(mediaContainerQueryStr+=notHide);waitForElement(`${mediaContainerQueryStr} .videoOsdBottom-maincontrols .videoOsdBottom-buttons`,(e=>{const t=getByClass(classes.videoOsdBottomButtonsRight,e),n=document.createElement("div");n.id=eleIds.danmakuCtr,window.ede.episode_info||(n.style.opacity=.5),t?e.insertBefore(n,t):e.append(n),mediaBtnOpts.forEach((e=>{n.appendChild(embyButton(e,e.onClick))})),console.log("UI初始化完成")}),0)}async function getEmbyItemInfo(){return window.require(["playbackManager"]).then((e=>e?.[0].currentItem()))}async function fatchEmbyItemInfo(e){return await ApiClient.getItem(ApiClient.getCurrentUserId(),e)}async function fetchSearchEpisodes(e,t){if(!e)throw new Error("anime is required");const n=dandanplayApi.getSearchEpisodes(e,t),i=await fetchJson(n).catch((e=>(console.log("查询失败:",e),null)));return console.log("查询成功",i),i}async function fetchComment(e){return fetchJson(dandanplayApi.getComment(e,window.ede.chConvert)).then((e=>(console.log("弹幕获取成功: "+e.comments.length),e.comments))).catch((e=>(console.log("弹幕获取失败:",e),null)))}async function fetchExtcommentActual(e){let t=(await fetchJson(dandanplayApi.getExtcomment(e))).comments;return 0===t.length&&(t=(await fetchJson(dandanplayApi.getExtcomment(e))).comments),t.map((t=>t.fromUrl=e)),window.ede.extConmentCache[e]=t,t}function onPlaybackStopped(e,t){if(!t.NowPlayingItem)return console.log("跳过 Web 端自身错误触发的第二次播放停止事件");console.log(e.type);const n=t.PlayState.PositionTicks,i=t.NowPlayingItem.RunTimeTicks;if(!i)return console.log("无可播放时长,跳过处理");const a=parseInt(n/i*100);console.log(`结束播放百分比: ${a}%`);const s=lsGetItem(lsKeys.bangumiPostPercent.id),l=lsGetItem(lsKeys.bangumiToken.id);if(lsGetItem(lsKeys.bangumiEnable.id)&&l&&a>=s&&window.ede.episode_info?.episodeId){console.log(`大于需提交的设定百分比: ${s}%`);const{animeTitle:e,episodeTitle:t}=window.ede.episode_info,n=`${e} - ${t}`;putBangumiEpStatus(l).then((e=>{embyToast({text:`putBangumiEpStatus 成功, 目标: ${n}, 结束播放百分比: ${a}%, 大于需提交的设定百分比: ${s}%`}),console.log(`putBangumiEpStatus 成功, 目标: ${n}`)})).catch((e=>{embyToast({text:`putBangumiEpStatus 失败, 目标: ${n}, ${e.message}`}),console.error(`putBangumiEpStatus 失败, 目标: ${n}`,e)}))}}async function getEpisodeBangumiRel(){const e=window.ede.episode_info,t=`_bangumi_episode_id_rel_${e.episodeId}`;let n=localStorage.getItem(t);n&&(n=JSON.parse(n));let i=n?.bangumiEpsRes,a=n?.subjectId,s=n?.bangumiUrl;const l=e.animeId;if(!a){if(!l)throw new Error("未获取到 animeId");if(s=(await fetchJson(dandanplayApi.getBangumi(l))).bangumi.bangumiUrl,!s)throw new Error("未请求到 bangumiUrl");a=parseInt(s.match(/\/(\d+)$/)[1])}const o=e?.episodeIndex,d={animeId:l,bangumiUrl:s,subjectId:a,episodeIndex:o,bangumiEpsRes:i,_bangumi_key:t};return window.ede.bangumiInfo=d,localStorage.setItem(d._bangumi_key,JSON.stringify(d)),d}async function putBangumiEpStatus(e){const t=await getEpisodeBangumiRel(),{subjectId:n,episodeIndex:i}=t;console.log("准备修改 Bangumi 条目收藏状态为在看, 如果不存在则创建, 如果存在则修改");let a={type:3};if(await fetchJson(bangumiApi.postUserCollection(n),{token:e,body:a}),!t.bangumiEpsRes){const a=bangumiApi.getUserSubjectEpisodeCollection(n),s=await fetchJson(a,{token:e});t.bangumiEpsRes=s;if(!s.data[i])throw new Error("未匹配到 bangumiEpColl");t.episodeIndex=i}const s=t.bangumiEpsRes.data[t.episodeIndex],l=s.episode;if(2===s.type)throw console.log("Bangumi 已是看过状态,跳过更新",l),new Error("Bangumi 已是看过状态,跳过更新");return console.log("准备更新 Bangumi 章节收藏状态, 详情: ",l),a.type=2,await fetchJson(bangumiApi.putUserEpisodeCollection(l.id),{token:e,body:a,method:"PUT"}),l.type=a.type,console.log("成功更新 Bangumi 章节收藏状态, 在看 => 看过, 详情: ",l),window.ede.bangumiInfo=t,localStorage.setItem(t._bangumi_key,JSON.stringify(t)),t}async function fetchJson(e,t={}){const{token:n,headers:i,body:a}=t;let{method:s="GET"}=t;"GET"===s&&a&&(s="POST");const l={"Accept-Encoding":"gzip",Accept:"application/json","Content-Type":"application/json","User-Agent":navigator.userAgent};n&&(l.Authorization=`Bearer ${n}`),i&&Object.assign(l,i);const o=a?JSON.stringify(a):null;try{const t=await fetch(e,{method:s,headers:l,body:o});if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);const n=await t.text();if(n.length>0)try{return JSON.parse(n)}catch(e){console.warn("responseText not is JSON:",e)}return{success:!0}}catch(e){throw e}}async function getMapByEmbyItemInfo(){const e=await getEmbyItemInfo();if(!e)return null;let t,n,i,a=-1;if("Episode"==e.Type){t=e.SeasonId,n=e.SeriesName,i=e.IndexNumber;let a=e.ParentIndexNumber;1!=a&&(n+=" "+a)}else t=e.Id,n=e.Name,i="movie";let s="_anime_id_rel_"+t,l="_anime_season_rel_"+t,o="_episode_id_rel_"+t+"_"+i;return window.localStorage.getItem(s)&&(a=window.localStorage.getItem(s)),{_id:t,_id_key:s,_season_key:l,_episode_key:o,animeId:a,episode:i,animeName:n,seriesOrMovieId:e.SeriesId||e.Id}}async function lsSeasonSearchEpisodes(e,t){const n=window.localStorage.getItem(e);if(!n)return null;const i=JSON.parse(n);let a=1/0,s=null;for(let e=0;e<i.length;e++){const n=i[e],l=t+n.episodeOffset;l>0&&l<a&&(a=l,s=n)}if(s){const e=t+s.episodeOffset;return console.log(`命中seasonInfo缓存: ${s.name},偏移量: ${s.episodeOffset},集: ${e}`),await fetchSearchEpisodes(s.name,e)}return null}async function autoFailback(e,t,n){console.log("自动匹配未查询到结果,可能为非番剧,将移除章节过滤,重试一次");let i=await fetchSearchEpisodes(e);if(i.animes.length>0){console.log("移除章节过滤,自动匹配成功,转换为目标章节索引 0");const n=i.animes[0].episodes[t-1??0];return n?(i.animes[0].episodes=[n],{animeName:e,animaInfo:i}):null}const a=await ApiClient.getItem(ApiClient.getCurrentUserId(),n);if(!a.OriginalTitle)return null;console.log(`标题名: ${e},自动匹配未查询到结果,将使用原标题名,重试一次`);const s=a.OriginalTitle;return i=await fetchSearchEpisodes(s,t),i.animes.length<1?null:(console.log(`使用原标题名: ${s},自动匹配成功`),{animeName:e,animeOriginalTitle:s,animaInfo:i})}async function searchEpisodes(e){const{_season_key:t,animeName:n,episode:i,seriesOrMovieId:a}=e;console.log(`[自动匹配] 标题名: ${n}`+(i?`,章节过滤: ${i}`:""));let s=await lsSeasonSearchEpisodes(t,i);if(s&&s.animes.length>0)return{animeOriginalTitle:"",animaInfo:s};if(s=await fetchSearchEpisodes(n,i),s&&s.animes.length>0)return{animeOriginalTitle:"",animaInfo:s};const l=await autoFailback(n,i,a);return l||void 0}async function getEpisodeInfo(e=!0){const t=await getMapByEmbyItemInfo();if(!t)return null;const{_episode_key:n,animeId:i,episode:a}=t;if(e&&window.localStorage.getItem(n))return JSON.parse(window.localStorage.getItem(n));const s=await searchEpisodes(t);if(!s||0===s.animaInfo.animes.length)return console.log("弹弹 Play 章节匹配失败"),appendvideoOsdDanmakuInfo(),null;const{animeOriginalTitle:l,animaInfo:o}=s;let d=1;if(-1!=i)for(let e=0;e<o.animes.length;e++)o.animes[e].animeId==i&&(d=e+1);d=parseInt(d)-1;const r={episodeId:o.animes[d].episodes[0].episodeId,episodeTitle:o.animes[d].episodes[0].episodeTitle,episodeIndex:isNaN(a)?0:a-1,animeId:o.animes[d].animeId,animeTitle:o.animes[d].animeTitle,animeOriginalTitle:l};return localStorage.setItem(n,JSON.stringify(r)),r}async function createDanmaku(e){if(!e)return;null!=window.ede.danmaku&&(window.ede.danmaku.destroy(),window.ede.danmaku=null);const t=danmakuParser(e);window.ede.commentsParsed=t;let n=danmakuFilter(t);console.log("弹幕加载成功: "+n.length);const i=document.querySelector(mediaContainerQueryStr),a=document.querySelector(mediaQueryStr);if(!a)throw new Error("用户已退出视频播放");isVersionOld||(a.style.position="absolute");let s=getById(eleIds.danmakuWrapper);s&&s.remove(),s=document.createElement("div"),s.id=eleIds.danmakuWrapper,s.style.position="fixed",s.style.width="100%",s.style.height=`calc(${lsGetItem(lsKeys.heightPercent.id)}% - 0px)`,s.style.backgroundColor=lsGetItem(lsKeys.debugShowDanmakuWrapper.id)?styles.colors.highlight:"",s.style.top="0px",s.style.pointerEvents="none",i.prepend(s);let l=144*lsGetItem(lsKeys.speed.id);window.ede.danmaku=new Danmaku({container:s,media:a,comments:n,engine:lsGetItem(lsKeys.engine.id),speed:l}),lsGetItem(lsKeys.switch.id)?window.ede.danmaku.show():window.ede.danmaku.hide(),window.ede.ob&&window.ede.ob.disconnect(),window.ede.ob=new ResizeObserver((()=>{window.ede.danmaku&&(console.log("Resizing"),window.ede.danmaku.resize(),lsGetItem(lsKeys.osdLineChartEnable.id)&&buildProgressBarChart(20))})),window.ede.ob.observe(i),a.id&&require(["playbackManager"],(e=>{e.getPlayerState().PlayState.IsPaused&&a.dispatchEvent(new Event("pause"))})),buildCurrentDanmakuInfo(currentDanmakuInfoContainerId),appendvideoOsdDanmakuInfo(n.length),lsGetItem(lsKeys.osdLineChartEnable.id)&&buildProgressBarChart(20)}function buildProgressBarChart(e){getById(eleIds.progressBarLineChart)?.remove();const t=window.ede?.danmaku?.comments,n=getByClass(classes.videoOsdPositionSliderContainer);if(!t||!n||t&&0===t.length)return;const i=n.offsetWidth;console.log("progressBarWidth: "+i);const a=document.createElement("canvas");a.id=eleIds.progressBarLineChart,a.width=i,a.height=e,a.style.position="absolute",a.style.top=OS.isEmbyNoisyX()?"-24px":"-21px",n.prepend(a);const s=a.getContext("2d"),l=Math.max(...t.map((e=>e.time))),o=Array.from({length:Math.ceil(l/1)},(()=>0));t.forEach((e=>{const t=Math.floor(e.time/1);t<o.length&&o[t]++})),function(t){s.clearRect(0,0,i,e);const n=Math.max(...t),a=e/n;s.beginPath(),s.moveTo(0,e-t[0]*a);for(let n=1;n<t.length;n++){const l=n/(t.length-1)*i,o=e-t[n]*a;s.lineTo(l,o)}s.strokeStyle="rgba(255, 255, 255, 0.6)",s.lineWidth=2,s.stroke()}(o),console.log("已重绘进度条弹幕数量折线图")}function loadDanmaku(e=LOAD_TYPE.CHECK){window.ede.loading?console.log("正在重新加载"):(window.ede.loading=!0,getEpisodeInfo(e!==LOAD_TYPE.SEARCH).then((t=>new Promise(((n,i)=>{t||(e!==LOAD_TYPE.INIT?i("播放器未完成加载"):i(null)),e!==LOAD_TYPE.SEARCH&&e!==LOAD_TYPE.REFRESH&&e!==LOAD_TYPE.RELOAD&&e!==LOAD_TYPE.INIT&&window.ede.danmaku&&window.ede.episode_info&&window.ede.episode_info.episodeId==t.episodeId?i("当前播放视频未变动"):(window.ede.episode_info=t,n(t.episodeId))})))).then((t=>{if(t){const n=window.ede.danmuCache[t],i=window.ede.extConmentCache,a=Object.keys(i).length;if(e===LOAD_TYPE.RELOAD&&(n||a>0)){let e=n;a>0&&(e=n.concat(...Object.values(i)),console.log(`使用 ede 缓存,附加前总量: ${n.length}, 附加后总量: ${e.length}`)),createDanmaku(e).then((()=>{console.log("弹幕就位")})).catch((e=>{console.log(e)}))}else fetchComment(t).then((e=>{window.ede.danmuCache[t]=e;let n=e;a>0?Promise.all(Object.entries(i).map((([e,t])=>fetchExtcommentActual(e)))).then((t=>{n=n.concat(...t),console.log(`使用 fetch 重取,附加前总量: ${e.length}, 附加后总量: ${n.length}`),createDanmaku(n).then((()=>{console.log("弹幕就位")})).catch((e=>{console.log(e)}))})).catch((e=>{console.error("Error fetching fetchExtcommentActual:",e)})):createDanmaku(n).then((()=>{console.log("弹幕就位")})).catch((e=>{console.log(e)}))}))}}),(e=>{e&&console.log(e)})).then((()=>{window.ede.loading=!1;const e=getById(eleIds.danmakuCtr);e&&"1"!==e.style.opacity&&(e.style.opacity="1")})).catch((e=>{console.log(e)})))}function danmakuFilter(e){let t=[...e];return t=danmakuTypeFilter(t),t=danmakuSourceFilter(t),t=danmakuDensityLevelFilter(t),t=danmakuKeywordsFilter(t),t}function danmakuTypeFilter(e){let t=lsGetItem(lsKeys.typeFilter.id);return t.includes(danmakuTypeFilterOpts.onlyWhite.id)&&(e=e.filter((e=>"#ffffff"===e.style.color.toLowerCase().slice(0,7))),t.splice(t.indexOf(danmakuTypeFilterOpts.onlyWhite.id),1)),t.includes(danmakuTypeFilterOpts.rolling.id)&&(e=e.filter((e=>danmakuTypeFilterOpts.ltr.id!==e.mode&&danmakuTypeFilterOpts.rtl.id!==e.mode)),t.splice(t.indexOf(danmakuTypeFilterOpts.rolling.id),1)),t.length>0&&(e=e.filter((e=>!t.includes(e.mode)))),e}function danmakuSourceFilter(e){return e.filter((e=>!lsGetItem(lsKeys.sourceFilter.id).includes(e.source)))}function danmakuDensityLevelFilter(e){let t=lsGetItem(lsKeys.filterLevel.id);if(0==t)return e;let n=9-2*t,i=[],a=[];for(let t=0;t<e.length;t++){let s=e[t],l=Math.ceil(s.time),o=Math.ceil(s.time/3);i[l]||(i[l]=[]),a[o]||(a[o]=[]),a[o].length<6?a[o].push(s):s.mode="rtl",i[l].length<n&&i[l].push(s)}return i.flat()}function danmakuKeywordsFilter(e){if(!lsGetItem(lsKeys.filterKeywordsEnable.id))return e;const t=lsGetItem(lsKeys.filterKeywords.id)?.split(/\r?\n/).map((e=>e.trim())).filter((e=>e.length>0&&!e.startsWith("// ")));if(0===t.length)return e;const n=["text",...Object.keys(showSource)];return e.filter((e=>!t.some((t=>{try{return n.some((n=>new RegExp(t).test(e[n])))}catch(i){return n.some((n=>e[n].includes(t)))}}))))}function danmakuParser(e){const t=lsGetItem(lsKeys.fontSizeRate.id);let n=25;const i=getByClass(classes.videoOsdTitle);n=i?parseFloat(getComputedStyle(i).fontSize.replace("px",""))*t:Math.round(18*(window.screen.height>window.screen.width?window.screen.width:window.screen.height/1080)*t);const a=lsGetItem(lsKeys.fontWeight.id),s=styles.fontStyles[lsGetItem(lsKeys.fontStyle.id)].id,l=Math.round(255*lsGetItem(lsKeys.fontOpacity.id)).toString(16),o=lsGetItem(lsKeys.timelineOffset.id),d=/\[(.*)\](.*)/,r=lsGetItem(lsKeys.showSource.id);return e.map((e=>{const t=e.p.split(","),i={6:"ltr",1:"rtl",5:"top",4:"bottom"}[t[1]];if(!i)return null;const m=`000000${Number(t[2]).toString(16)}${l}`.slice(-8),c={text:e.m,mode:i,time:1*t[0]+o,style:{color:`#${m}`,textShadow:"00000"===m?"-1px -1px #fff, -1px 1px #fff, 1px -1px #fff, 1px 1px #fff":"-1px -1px #000, -1px 1px #000, 1px -1px #000, 1px 1px #000",font:`${s} ${a} ${n}px sans-serif`,fillStyle:`#${m}`,strokeStyle:"000000"===m?`#ffffff${l}`:`#000000${l}`,lineWidth:2},[showSource.cid.id]:e.cid,[showSource.source.id]:t[3].match(d)?.[1]||danmakuSource.DanDanPlay.id,[showSource.originalUserId.id]:t[3].match(d)?.[2]||t[3]};return r.length>0&&(c.originalText=c.text,c.text+=r.map((e=>e===showSource.source.id?`,[${c[e]}]`:","+c[e])).join("")),c.cuid=c[showSource.cid.id]+","+c[showSource.originalUserId.id],c})).filter((e=>e)).sort(((e,t)=>e.time-t.time))}function toastByDanmaku(e,t){e=toastPrefixes.system+e;const n=1.5*parseFloat(getComputedStyle(getByClass(classes.videoOsdTitle)).fontSize.replace("px","")),i=styles.colors[t],a=document.querySelector(mediaQueryStr).currentTime,s="ff",l=`000000${i.toString(16)}${s}`.slice(-8),o={text:e,mode:"top",time:a,style:{fontSize:`${n}px`,color:`#${l}`,textShadow:"00000"===l?"-1px -1px #fff, -1px 1px #fff, 1px -1px #fff, 1px 1px #fff":"-1px -1px #000, -1px 1px #000, 1px -1px #000, 1px 1px #000",font:`${n}px sans-serif`,fillStyle:`#${l}`,strokeStyle:"000000"===l?`#ffffff${s}`:`#000000${s}`,lineWidth:2}};window.ede.danmaku.emit(o)}function createDialog(){require(["emby-select","emby-checkbox","emby-slider","emby-textarea","emby-collapse"]);embyDialog({html:`<div id="${eleIds.dialogContainer}"></div>`,buttons:[{name:"关闭"}]}),waitForElement("#"+eleIds.dialogContainer,afterEmbyDialogCreated)}async function afterEmbyDialogCreated(e){const t=await getMapByEmbyItemInfo();t&&(window.ede.searchDanmakuOpts={_id_key:t._id_key,_season_key:t._season_key,_episode_key:t._episode_key,animeId:t.animeId,animeName:t.animeName,seriesOrMovieId:t.seriesOrMovieId,episode:(parseInt(t.episode)||1)-1,animes:[]});let n=getByClass(classes.formDialogHeader);const i=getByClass(classes.formDialogFooter);n=n||e;const a=document.createElement("div");a.className=classes.embyTabsMenu,a.append(embyTabs(danmakuTabOpts,danmakuTabOpts[0].id,"id","name",(e=>{danmakuTabOpts.forEach((t=>{const n=getById(t.id);n&&(n.hidden=t.id!==e.id)}))}))),n.append(a),n.style="width: 100%; padding: 0; height: auto;",danmakuTabOpts.forEach(((t,n)=>{const i=document.createElement("div");i.id=t.id,i.style.textAlign="left",i.hidden=0!=n,e.append(i);try{t.buildMethod(t.id)}catch(e){console.error(e)}})),i&&(i.style.padding="0.3em")}function buildDanmakuSetting(e){const t=getById(e);let n=`\n            <div style="display: flex; justify-content: center;">\n                <div>\n                    <div id="${eleIds.danmakuSwitchDiv}" style="margin-bottom: 0.2em;">\n                        <label class="${classes.embyLabel}">${lsKeys.switch.name} </label>\n                    </div>\n                    <div style="${styles.embySlider}">\n                        <label class="${classes.embyLabel}" style="width: 5em;">${lsKeys.filterLevel.name}: </label>\n                        <div id="${eleIds.filterLevelDiv}" style="width: 15.5em; text-align: center;"></div>\n                        <label id="${eleIds.filterLevelLabel}" style="width: 4em;">0</label>\n                    </div>\n                    <div style="${styles.embySlider}">\n                        <label class="${classes.embyLabel}" style="width: 5em;">${lsKeys.heightPercent.name}: </label>\n                        <div id="${eleIds.heightPercentDiv}" style="width: 15.5em; text-align: center;"></div>\n                        <label>\n                            <label id="${eleIds.heightPercentLabel}" style="width: 4em;"></label>\n                            <label>%</label>\n                        </label>\n                    </div>\n                    <div style="${styles.embySlider}">\n                        <label class="${classes.embyLabel}" style="width: 5em;">${lsKeys.fontSizeRate.name}: </label>\n                        <div id="${eleIds.danmakuSizeDiv}" style="width: 15.5em; text-align: center;"></div>\n                        <label>\n                            <label id="${eleIds.danmakuSizeLabel}" style="width: 4em;"></label>\n                            <label>倍</label>\n                        </label>\n                    </div>\n                    <div style="${styles.embySlider}">\n                        <label class="${classes.embyLabel}" style="width: 5em;">${lsKeys.fontOpacity.name}: </label>\n                        <div id="${eleIds.danmakuOpacityDiv}" style="width: 15.5em; text-align: center;"></div>\n                        <label id="${eleIds.danmakuOpacityLabel}" style="width: 4em;"></label>\n                    </div>\n                    <div style="${styles.embySlider}">\n                        <label class="${classes.embyLabel}" style="width: 5em;">${lsKeys.speed.name}: </label>\n                        <div id="${eleIds.danmakuSpeedDiv}" style="width: 15.5em; text-align: center;"></div>\n                        <label>\n                            <label id="${eleIds.danmakuSpeedLabel}" style="width: 4em;"></label>\n                            <label>倍</label>\n                        </label>\n                    </div>\n                    <div style="${styles.embySlider}">\n                        <label class="${classes.embyLabel}" style="width: 5em;">${lsKeys.fontWeight.name}: </label>\n                        <div id="${eleIds.danmakuFontWeightDiv}" style="width: 15.5em; text-align: center;"></div>\n                        <label id="${eleIds.danmakuFontWeightLabel}" style="width: 4em;"></label>\n                    </div>\n                    <div style="${styles.embySlider}">\n                        <label class="${classes.embyLabel}" style="width: 5em;">${lsKeys.fontStyle.name}: </label>\n                        <div id="${eleIds.danmakuFontStyleDiv}" style="width: 15.5em; text-align: center;"></div>\n                        <label id="${eleIds.danmakuFontStyleLabel}" style="width: 4em;">正常</label>\n                    </div>\n                    <div style="${styles.embySlider}">\n                        <label class="${classes.embyLabel}" style="width: 5em;">${lsKeys.timelineOffset.name}: </label>\n                        <div id="${eleIds.timelineOffsetDiv}" style="width: 15.5em; text-align: center;"></div>\n                        <label id="${eleIds.timelineOffsetLabel}" style="width: 4em;"></label>\n                    </div>\n                    <div id="${eleIds.settingsCtrl}" style="margin: 0.6em 0;"></div>\n                    <textarea id="${eleIds.settingsText}" style="display: none;resize: vertical;width: 100%" rows="20" \n                        is="emby-textarea" class="txtOverview emby-textarea"></textarea>\n                </div>\n            </div>\n        `;t.innerHTML=n.trim(),getById(eleIds.danmakuSwitchDiv,t).prepend(embyButton({id:eleIds.danmakuSwitch,label:"弹幕开关",iconKey:lsGetItem(lsKeys.switch.id)?iconKeys.switch_on:iconKeys.switch_off,style:(lsGetItem(lsKeys.switch.id)?"color:#52b54b;":"")+"font-size:1.5em;padding:0;"},doDanmakuSwitch)),getById(eleIds.filterLevelDiv,t).append(embySlider({labelId:eleIds.filterLevelLabel,key:lsKeys.filterLevel.id},{value:lsGetItem(lsKeys.filterLevel.id),min:0,max:3,step:1},onSliderChange,onSliderChangeLabel)),getById(eleIds.heightPercentDiv,t).append(embySlider({labelId:eleIds.heightPercentLabel,key:lsKeys.heightPercent.id},{value:lsGetItem(lsKeys.heightPercent.id),min:3,max:100,step:1},onSliderChange,onSliderChangeLabel)),getById(eleIds.danmakuSizeDiv,t).append(embySlider({labelId:eleIds.danmakuSizeLabel,key:lsKeys.fontSizeRate.id},{value:lsGetItem(lsKeys.fontSizeRate.id)},onSliderChange,onSliderChangeLabel)),getById(eleIds.danmakuOpacityDiv,t).append(embySlider({labelId:eleIds.danmakuOpacityLabel,key:lsKeys.fontOpacity.id},{max:1,value:lsGetItem(lsKeys.fontOpacity.id)},onSliderChange,onSliderChangeLabel)),getById(eleIds.danmakuSpeedDiv,t).append(embySlider({labelId:eleIds.danmakuSpeedLabel,key:lsKeys.speed.id},{value:lsGetItem(lsKeys.speed.id)},onSliderChange,onSliderChangeLabel)),getById(eleIds.danmakuFontWeightDiv,t).append(embySlider({labelId:eleIds.danmakuFontWeightLabel,key:lsKeys.fontWeight.id},{value:lsGetItem(lsKeys.fontWeight.id),min:100,max:1e3,step:100},onSliderChange,onSliderChangeLabel)),getById(eleIds.danmakuFontStyleDiv,t).append(embySlider({labelId:eleIds.danmakuFontStyleLabel,key:lsKeys.fontStyle.id},{value:lsGetItem(lsKeys.fontStyle.id),min:0,max:2,step:1},((e,t)=>onSliderChange(e,t,null,styles.fontStyles[e].name)),((e,t)=>onSliderChangeLabel(styles.fontStyles[e].name,t))));const i=getById(eleIds.timelineOffsetDiv,t),a={labelId:eleIds.timelineOffsetLabel,key:lsKeys.timelineOffset.id};onSliderChangeLabel(lsGetItem(lsKeys.timelineOffset.id),a),timeOffsetBtns.forEach((e=>{i.append(embyButton(e,(e=>{if(e.target){let t=lsGetItem(lsKeys.timelineOffset.id),n=t+(parseFloat(e.target.getAttribute("valueOffset"))||0);n===t&&(n=0),onSliderChange(n,a)}})))})),buildSettingsBackup(t)}function buildSettingsBackup(e){const t=getById(eleIds.settingsCtrl,e);t.append(embyButton({label:"配置",iconKey:iconKeys.more},(e=>{const t=!e.target.xChecked;e.target.xChecked=t,e.target.title=t?"关闭":"配置",e.target.firstChild.innerHTML=t?iconKeys.close:iconKeys.more;const n=getById(eleIds.settingsText);n.style.display=t?"":"none",t&&(n.value=getSettingsJson(2)),[eleIds.settingReloadBtn,eleIds.settingsImportBtn].forEach((e=>{getById(e).style.display=t?"":"none"}))}))),t.append(embyButton({id:eleIds.settingReloadBtn,label:"刷新",iconKey:iconKeys.refresh,style:"display: none;"},(()=>getById(eleIds.settingsText).value=getSettingsJson(2)))),t.append(embyButton({id:eleIds.settingsImportBtn,label:"应用",iconKey:iconKeys.done,style:"display: none;"},(()=>{lsBatchSet(JSON.parse(getById(eleIds.settingsText).value)),loadDanmaku(LOAD_TYPE.INIT),closeEmbyDialog()})))}function buildSearchEpisode(e){const t=getById(e),n=window.ede.danmuCache[window.ede.episode_info?.episodeId]??[];let i=`\n            <div>\n                <div>\n                    <label class="${classes.embyLabel}">标题: </label>\n                    <div id="${eleIds.danmakuSearchNameDiv}" style="display: flex;"></div>\n                </div>\n                <div id="${eleIds.danmakuEpisodeFlag}" hidden>\n                    <div style="display: flex;">\n                        <div style="width: 80%;">\n                            <label class="${classes.embyLabel}">媒体名: </label>\n                            <div id="${eleIds.danmakuAnimeDiv}" class="${classes.embySelectWrapper}"></div>\n                            <label class="${classes.embyLabel}">分集名: </label>\n                            <div style="display: flex;">\n                                <div id="${eleIds.danmakuEpisodeNumDiv}" style="max-width: 90%;" class="${classes.embySelectWrapper}"></div>\n                                <div id="${eleIds.danmakuEpisodeLoad}"></div>\n                            </div>\n                        </div>\n                        <img id="${eleIds.searchImg}" style="width: 20%;height: 100%;margin: 2%;"\n                            loading="lazy" decoding="async" draggable="false" class="coveredImage-noScale"></img>\n                        </div>\n                    </div>\n                <div hidden>\n                    <label class="${classes.embyLabel}" id="${eleIds.danmakuRemark}"></label>\n                </div>\n                <div>\n                    <h4>匹配源</h4>\n                    <div>\n                        <div id="${eleIds.currentMatchedDiv}">\n                            <label class="${classes.embyLabel}">弹弹 play 总量: ${n.length}</label>\n                        </div>\n                        <label class="${classes.embyLabel}">弹弹 play 附加的第三方 url: </label>\n                    </div>\n                    <div id="${eleIds.extUrlsDiv}"></div>\n                </div>\n                <div is="emby-collapse" title="附加弹幕">\n                    <div class="${classes.collapseContentNav}">\n                        <label class="${classes.embyLabel}">弹弹 play 支持解析的第三方 url: </label>\n                        <div id="${eleIds.extConmentSearchDiv}" style="display: flex;"></div>\n                        <div class="${classes.embyFieldDesc}">\n                            原接口文档说明支持(如A/B/C站),自测另外支持[ 爱奇艺视频, 腾讯视频, 优酷视频, ],不支持[ 芒果 TV, ]\n                        </div>\n                        <div class="${classes.embyFieldDesc}">\n                            仅[ 爱奇艺视频, ]需要注意网址后不能带 ? 的参数,其余网址带不带都可以\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;t.innerHTML=i.trim();const a=getById(eleIds.danmakuSearchNameDiv,t);a.append(embyInput({id:eleIds.danmakuSearchName,value:window.ede.searchDanmakuOpts.animeName,type:"search"},doDanmakuSearchEpisode)),a.append(embyButton({label:"搜索",iconKey:iconKeys.search},doDanmakuSearchEpisode)),a.append(embyButton({label:"切换[原]标题",iconKey:iconKeys.text_format},doSearchTitleSwtich)),getById(eleIds.danmakuEpisodeLoad,t).append(embyButton({id:eleIds.danmakuSwitchEpisode,label:"加载弹幕",iconKey:iconKeys.done},doDanmakuSwitchEpisode));const s=getById(eleIds.currentMatchedDiv,t);s.append(embyButton({label:"取消匹配/清空弹幕",iconKey:iconKeys.close},(e=>{window.ede.episode_info?.episodeId&&(window.ede.episode_info.episodeId=null),window.ede.danmaku&&createDanmaku([]),s.querySelector("label").textContent="弹弹 play 总量: 0"})));const l=getById(eleIds.extConmentSearchDiv,t);buildExtUrlsDiv(),l.append(embyInput({type:"search",placeholder:"http(s)://"},onEnterExtConment)),l.append(embyButton({label:"搜索",iconKey:iconKeys.search},onEnterExtConment))}function buildExtUrlsDiv(){const e=(window.ede.danmuCache[window.ede.episode_info?.episodeId]??[]).concat(...Object.values(window.ede.extConmentCache)),t=getById(eleIds.extUrlsDiv);t.innerHTML="",Object.entries(window.ede.extConmentCache).forEach((([n,i])=>{const a=document.createElement("div");a.append(embyButton({label:"清空此加载",iconKey:iconKeys.close},(t=>{delete window.ede.extConmentCache[n],t.target.parentNode.remove(),createDanmaku(e.filter((e=>e.fromUrl!==n)))}))),a.append(embyALink(n),document.createTextNode(` 总量: ${i.length}`)),t.append(a)}))}async function onEnterExtConment(e){const t=getTargetInput(e).value.trim();if(!t.startsWith("http"))return embyToast({text:"输入的 url 应以 http 开头!"});let n=window.ede.extConmentCache[t];n||(n=await fetchExtcommentActual(t));const i=(window.ede.danmuCache[window.ede.episode_info?.episodeId]??[]).concat(...Object.values(window.ede.extConmentCache));createDanmaku(i).then((()=>{const e=window.ede.commentsParsed.length-n.length;embyToast({text:`此次附加总量: ${n.length}, 附加前总量: ${e}, 附加后总量: ${i.length}`}),console.log(`附加弹幕就位, 附加前总量: ${e}`),buildExtUrlsDiv()})).catch((e=>console.log(e)))}function buildCurrentDanmakuInfo(e){const t=getById(e);if(!t||!window.ede.episode_info)return;const{episodeTitle:n,animeId:i,animeTitle:a}=window.ede.episode_info,s=getDanmakuComments(window.ede).length,l=window.ede.commentsParsed.length;let o=`\n            <div style="display: flex;">\n                <div id="${eleIds.posterImgDiv}"></div>\n                <div>\n                    <div>\n                        <label class="${classes.embyLabel}">媒体名: </label>\n                        <div class="${classes.embyFieldDesc}">${a}</div>\n                    </div>\n                    ${n?`<div>\n                        <label class="${classes.embyLabel}">分集名: </label>\n                        <div class="${classes.embyFieldDesc}">${n}</div>\n                    </div>`:""}\n                    <div>\n                        <label class="${classes.embyLabel}">其它信息: </label>\n                        <div class="${classes.embyFieldDesc}">\n                            获取总数: ${l}, \n                            加载总数: ${s}, \n                            被过滤数: ${l-s}\n                        </div>\n                    </div>\n                </div>\n            </div>\n            <div style="margin-top: 2%;">\n                <label class="${classes.embyLabel}">${lsKeys.danmuList.name}: </label>\n                <div id="${eleIds.danmuListDiv}" style="margin: 1% 0;"></div>\n                <textarea id="${eleIds.danmuListText}" readOnly style="display: none;resize: vertical;width: 100%" rows="8" \n                    is="emby-textarea" class="txtOverview emby-textarea"></textarea>\n                <div class="${classes.embyFieldDesc}">列表展示格式为: [序号][分:秒] : 弹幕正文 [来源平台][用户ID][弹幕CID][模式]</div>\n            </div>\n            <div id="${eleIds.extInfoCtrlDiv}" style="margin: 0.6em 0;"></div>\n            <div id="${eleIds.extInfoDiv}" hidden>\n                <label class="${classes.embyLabel}">Bangumi 角色介绍: </label>\n                <div style="${styles.embySlider+"margin: 0.8em 0;"}">\n                    <label class="${classes.embyLabel}" style="width:7em;">角色图片高度: </label>\n                    <div id="${eleIds.characterImgHeihtDiv}" style="width: 36.5em; text-align: center;"></div>\n                    <label><label id="${eleIds.characterImgHeihtLabel}" style="width:4em;"></label>\n                    <label>em</label></label>\n                </div>\n                <div id="${eleIds.charactersDiv}" style="display: flex; flex-wrap: wrap; gap: .5em;"></div>\n            </div>\n        `;t.innerHTML=o.trim(),i&&getById(eleIds.posterImgDiv,t).append(embyImgButton(embyImg(dandanplayApi.posterImg(i)),"width: calc((var(--videoosd-tabs-height) - 3em) * (2 / 3)); margin-right: 1em;"));const d=Object.values(window.ede.extConmentCache).map(((e,t)=>({id:`ext${t+1}`,name:`附加${t+1}`,onChange:()=>danmakuParser(e)})));getById(eleIds.danmuListDiv,t).append(embyTabs(danmuListOpts.concat(d),lsKeys.danmuList.defaultValue,"id","name",doDanmuListOptsChange)),buildExtInfo(t)}function buildExtInfo(e){getById(eleIds.characterImgHeihtDiv,e).append(embySlider({labelId:eleIds.characterImgHeihtLabel},{value:"12",min:12,max:100,step:1},null,((e,t)=>{"12"===e&&(e="auto"),onSliderChangeLabel(e,t),Array.from(getById(eleIds.charactersDiv).children).map((t=>t.style.height="auto"===e?e:e+"em"))})));getById(eleIds.extInfoCtrlDiv,e).append(embyButton({label:"额外信息",iconKey:iconKeys.more},(e=>{const t=!e.target.xChecked;e.target.xChecked=t,e.target.title=t?"关闭":"额外信息",e.target.firstChild.innerHTML=t?iconKeys.close:iconKeys.more;getById(eleIds.extInfoDiv).hidden=!t;const n=getById(eleIds.charactersDiv);if(!n.firstChild){if(window.ede.bangumiInfo?.characters&&window.ede.bangumiInfo.animeId===window.ede.episode_info.animeId)return i(n,window.ede.bangumiInfo.characters);getEpisodeBangumiRel().then((e=>fetchJson(bangumiApi.getCharacters(e.subjectId)))).then((e=>{window.ede.bangumiInfo.characters=e,i(n,e)}))}function i(e,t){t.map((t=>{const n=document.createElement("div");n.style="width: 32%; display: flex; gap: .5em;";let i=embyImg(t.images.large,"object-position: top;");t.images.large||(i=embyI(iconKeys.person,classes.cardImageIcon)),n.append(embyImgButton(i));const a=document.createElement("div"),s=document.createElement("div");s.textContent=t.relation+": "+t.name,a.append(s);const l=document.createElement("div");l.textContent="CV: "+t.actors.map((e=>e.name)).join(),t.actors[0]&&l.append(embyImgButton(embyImg(t.actors[0].images.large))),a.append(l),n.append(a),e.append(n)}))}})))}function buildProSetting(e){const t=getById(e);let n=`\n            <div style="height: 30em;">\n                <div is="emby-collapse" title="弹幕屏蔽" data-expanded="true">\n                    <div class="${classes.collapseContentNav}">\n                        <div id="${eleIds.danmakuTypeFilterDiv}" style="margin-bottom: 0.2em;">\n                            <label class="${classes.embyLabel}">${lsKeys.typeFilter.name}: </label>\n                        </div>\n                        <div id="${eleIds.danmakuSourceFilterDiv}">\n                            <label class="${classes.embyLabel}">${lsKeys.sourceFilter.name}: </label>\n                        </div>\n                        <div id="${eleIds.danmakuShowSourceDiv}">\n                            <label class="${classes.embyLabel}">${lsKeys.showSource.name}: </label>\n                        </div>\n                        <div id="${eleIds.filterKeywordsDiv}" style="margin-bottom: 0.2em;">\n                            <label class="${classes.embyLabel}">${lsKeys.filterKeywords.name}: </label>\n                        </div>\n                    </div>\n                </div>\n                <div is="emby-collapse" title="额外设置">\n                    <div class="${classes.collapseContentNav}" style="padding-top: 0.5em !important;">\n                        <div id="${eleIds.extCheckboxDiv}"></div>\n                        <div id="${eleIds.danmakuChConverDiv}" style="margin-bottom: 0.2em;">\n                            <label class="${classes.embyLabel}">${lsKeys.chConvert.name}: </label>\n                        </div>\n                        <div id="${eleIds.danmakuEngineDiv}" style="margin-bottom: 0.2em;">\n                            <label class="${classes.embyLabel}">${lsKeys.engine.name}: </label>\n                        </div>\n                    </div>\n                </div>\n                <div is="emby-collapse" title="播放设置">\n                    <div class="${classes.collapseContentNav}">\n                        <label class="${classes.embyLabel}">单次定时执行: </label>\n                        <div id="${eleIds.timeoutCallbackTypeDiv}"></div>\n                        <label class="${classes.embyLabel}">定时单位: </label>\n                        <div id="${eleIds.timeoutCallbackUnitDiv}"></div>\n                        <div style="${styles.embySlider+"margin-top: 0.3em;"}">\n                            <label class="${classes.embyLabel}" style="width:4em;">${lsKeys.timeoutCallbackValue.name}: </label>\n                            <div id="${eleIds.timeoutCallbackDiv}" style="width: 15.5em; text-align: center;"></div>\n                            <label id="${eleIds.timeoutCallbackLabel}" style="width:4em;"></label>\n                        </div>\n                    </div>\n                </div>\n                <div is="emby-collapse" title="Bangumi 设置">\n                    <div class="${classes.collapseContentNav}" style="padding-top: 0.5em !important;">\n                        <label id="${eleIds.bangumiEnableLabel}" class="${classes.embyLabel}"></label>\n                        <div id="${eleIds.bangumiSettingsDiv}">\n                            <div id="${eleIds.bangumiTokenInputDiv}" style="display: flex;" ></div>\n                            <div id="${eleIds.bangumiTokenLabel}" class="${classes.embyFieldDesc}"></div>\n                            <div class="${classes.embyFieldDesc}">\n                                你可以在以下链接生成一个 Access Token\n                            </div>\n                            <div id="${eleIds.bangumiTokenLinkDiv}" style="padding-bottom: 0.5em;"></div>\n                            <label class="${classes.embyLabel}">自动更新单章节收藏信息: </label>\n                            <div style="${styles.embySlider}">\n                                <label class="${classes.embyLabel}" style="width:4em;">${lsKeys.bangumiPostPercent.name}: </label>\n                                <div id="${eleIds.bangumiPostPercentDiv}" style="width: 15.5em; text-align: center;"></div>\n                                <label>\n                                    <label id="${eleIds.bangumiPostPercentLabel}" style="width:4em;"></label>\n                                    <label>%</label>\n                                </label>\n                            </div>\n                            <div class="${classes.embyFieldDesc}">\n                                触发时机为正常停止播放,且播放进度超过设定百分比时;\n                                同步的媒体信息为自动匹配而来,可在"弹幕信息"中查看;\n                                自动匹配有误可"手动匹配",仍无法匹配可点击按钮X"取消匹配/清除弹幕",则此单章节不会同步;\n                            </div>\n                        </div>\n                    </div>\n                </div>\n                <div is="emby-collapse" title="自定义接口地址">\n                    <div id="${eleIds.customeUrlsDiv}" class="${classes.collapseContentNav}"></div>\n                </div>\n            </div>\n        `;t.innerHTML=n.trim(),buildDanmakuFilterSetting(t),buildExtSetting(t),buildPlaySetting(t),buildBangumiSetting(t),buildCustomUrlSetting(t)}function buildDanmakuFilterSetting(e){getById(eleIds.danmakuTypeFilterDiv,e).append(embyCheckboxList(null,eleIds.danmakuTypeFilterSelectName,lsGetItem(lsKeys.typeFilter.id),Object.values(danmakuTypeFilterOpts).filter((e=>!e.hidden)),doDanmakuTypeFilterSelect)),getById(eleIds.danmakuSourceFilterDiv,e).append(embyCheckboxList(null,eleIds.danmakuSourceFilterSelectName,lsGetItem(lsKeys.sourceFilter.id),Object.values(danmakuSource),doDanmakuSourceFilterSelect)),getById(eleIds.danmakuShowSourceDiv,e).append(embyCheckboxList(null,eleIds.danmakuShowSourceSelectName,lsGetItem(lsKeys.showSource.id),Object.values(showSource),doDanmakuShowSourceSelect));const t=getById(eleIds.filterKeywordsDiv,e),n=t.appendChild(document.createElement("div")),i=embyButton({label:"加载关键词过滤",iconKey:iconKeys.done_disabled},doDanmakuFilterKeywordsBtnClick);i.disabled=!0,n.setAttribute("style","display: flex; justify-content: space-between; align-items: center; width: 100%;"),n.append(embyCheckbox({id:eleIds.filterKeywordsEnableId,label:lsKeys.filterKeywordsEnable.name.replace(lsKeys.filterKeywords.name,"")},lsGetItem(lsKeys.filterKeywordsEnable.id),(e=>updateFilterKeywordsBtn(i,e,getById(eleIds.filterKeywordsId).value.trim())))),n.appendChild(document.createElement("div")).appendChild(i),t.appendChild(document.createElement("div")).appendChild(embyTextarea({id:eleIds.filterKeywordsId,value:lsGetItem(lsKeys.filterKeywords.id),style:"width: 100%;margin-top: 0.2em;",rows:8},(e=>updateFilterKeywordsBtn(i,getById(eleIds.filterKeywordsEnableId).checked,e.target.value.trim()))));const a=document.createElement("label");a.innerText=`关键词/正则匹配过滤,支持过滤[正文,${Object.values(showSource).map((e=>e.name)).join()}],多个表达式用换行分隔`,a.className=classes.embyFieldDesc,t.appendChild(document.createElement("div")).appendChild(a)}function buildExtSetting(e){getById(eleIds.extCheckboxDiv,e).append(embyCheckbox({label:lsKeys.osdTitleEnable.name},lsGetItem(lsKeys.osdTitleEnable.id),(e=>{lsSetItem(lsKeys.osdTitleEnable.id,e);const t=document.querySelector(`${mediaContainerQueryStr} .videoOsdSecondaryText`),n=getById(eleIds.videoOsdDanmakuTitle,t);n?n.style.display=e?"block":"none":e&&appendvideoOsdDanmakuInfo(getDanmakuComments(window.ede).length)}))),getById(eleIds.extCheckboxDiv,e).append(embyCheckbox({label:lsKeys.osdLineChartEnable.name},lsGetItem(lsKeys.osdLineChartEnable.id),(e=>{lsSetItem(lsKeys.osdLineChartEnable.id,e);const t=getById(eleIds.progressBarLineChart);t?t.style.display=e?"block":"none":e&&buildProgressBarChart(20)}))),getById(eleIds.danmakuChConverDiv,e).append(embyTabs(danmakuChConverOpts,window.ede.chConvert,"id","name",doDanmakuChConverChange)),getById(eleIds.danmakuEngineDiv,e).append(embyTabs(danmakuEngineOpts,lsGetItem(lsKeys.engine.id),"id","name",doDanmakuEngineSelect))}function buildPlaySetting(e){const t=getById(eleIds.timeoutCallbackDiv,e),n={labelId:eleIds.timeoutCallbackLabel,key:lsKeys.timeoutCallbackValue.id};onSliderChangeLabel(lsGetItem(lsKeys.timeoutCallbackValue.id),n),timeOffsetBtns.forEach((e=>{t.append(embyButton(e,(e=>{if(e.target){let t=lsGetItem(lsKeys.timeoutCallbackValue.id),i=t+(parseFloat(e.target.getAttribute("valueOffset"))||0);(i===t||i<0)&&(i=0),onSliderChange(i,n,!1)}})))})),getById(eleIds.timeoutCallbackUnitDiv,e).append(embyTabs(timeoutCallbackUnitOpts,lsGetItem(lsKeys.timeoutCallbackUnit.id),"id","name",((e,t)=>{lsSetItem(lsKeys.timeoutCallbackUnit.id,t)}))),getById(eleIds.timeoutCallbackTypeDiv,e).append(embyTabs(timeoutCallbackTypeOpts,timeoutCallbackTypeOpts[0].id,"id","name",(e=>{const t=timeoutCallbackUnitOpts[lsGetItem(lsKeys.timeoutCallbackUnit.id)];e.onChange(lsGetItem(lsKeys.timeoutCallbackValue.id)*t.msRate)})))}function buildBangumiSetting(e){const t=getById(eleIds.bangumiSettingsDiv,e),n=lsGetItem(lsKeys.bangumiEnable.id);t.hidden=!n;getById(eleIds.bangumiEnableLabel,e).append(embyCheckbox({label:lsKeys.bangumiEnable.name},n,(e=>{lsSetItem(lsKeys.bangumiEnable.id,e),t.hidden=!e})));const i=getById(eleIds.bangumiTokenInputDiv,e);i.append(embyInput({id:eleIds.bangumiTokenInput,type:"password",value:lsGetItem(lsKeys.bangumiToken.id)},onEnterBangumiToken)),i.append(embyButton({label:"校验",iconKey:iconKeys.check},onEnterBangumiToken)),getById(eleIds.bangumiPostPercentDiv,e).append(embySlider({labelId:eleIds.bangumiPostPercentLabel,key:lsKeys.bangumiPostPercent.id},{value:lsGetItem(lsKeys.bangumiPostPercent.id),min:1,max:99,step:1},((e,t)=>{onSliderChange(e,t,!1)}),onSliderChangeLabel));getById(eleIds.bangumiTokenLinkDiv,e).append(embyALink(bangumiApi.accessTokenUrl,bangumiApi.accessTokenUrl))}function onEnterBangumiToken(e){const t=getById(eleIds.bangumiTokenInput).value.trim();lsSetItem(lsKeys.bangumiToken.id,t);const n=getById(eleIds.bangumiTokenLabel);fetchJson(bangumiApi.getMyself(),{token:t}).then((e=>{n.innerText="Bangumi Token 验证成功",n.style.color="green",console.log("bangumiApi.getMyself()",e)})).catch((e=>{throw n.innerText="Bangumi Token 验证失败",n.style.color="red",e}))}function buildCustomUrlSetting(e){customeUrl.mapping.map((t=>(getById(eleIds.customeUrlsDiv,e).innerHTML+=(e=>`\n            <label class="${classes.embyLabel}">${e.lsKey.name}(${e.msg1}): </label>\n            <div id="${e.divId}" style="display: flex;" ></div>\n            <div class="${classes.embyFieldDesc}">${e.msg2?e.msg2:""}</div>\n        `)(t),t))).map((t=>{const n=getById(t.divId,e),i=e=>{const n=getTargetInput(e);let i=n.value.trim();i||(i=t.lsKey.defaultValue,n.value=i),lsSetItem(t.lsKey.id,i),t.rewrite(i)};n.append(embyInput({type:"search",value:lsGetItem(t.lsKey.id)},i)),n.append(embyButton({label:"确认",iconKey:iconKeys.check},i))}))}function buildAbout(e){const t=getById(e);if(!t)return;const n=`\n            <div style="height: 30em;">\n                <div id="${eleIds.consoleLogCtrl}"></div>\n                <div id="${eleIds.consoleLogInfo}">\n                    <textarea id="${eleIds.consoleLogText}" readOnly style="resize: vertical;margin-top: 0.6em;"\n                        rows="14" is="emby-textarea" class="txtOverview emby-textarea"></textarea>\n                    <textarea id="${eleIds.consoleLogTextInput}" hidden style="resize: vertical;"\n                        rows="1" is="emby-textarea" class="txtOverview emby-textarea"></textarea>\n                </div>\n                <div class="${classes.embyFieldDesc}">注意开启后原本控制台中调用方信息将被覆盖,不使用请保持关闭状态</div>\n                <div id="${eleIds.consoleLogCtrl}"></div>\n                <div is="emby-collapse" title="开发者选项">\n                    <div class="${classes.collapseContentNav}">\n                        <label class="${classes.embyLabel}">调试开关: </label>\n                        <div id="${eleIds.debugCheckbox}"></div>\n                        <label class="${classes.embyLabel}">调试按钮: </label>\n                        <div id="${eleIds.debugButton}"></div>\n                    </div>\n                </div>\n                <div is="emby-collapse" title="开放源代码许可" data-expanded="true">\n                    <div id="${eleIds.openSourceLicenseDiv}" class="${classes.collapseContentNav}" style="display: flex; flex-direction: column;"></div>\n                </div>\n            </div>\n        `;t.innerHTML=n.trim(),buildConsoleLog(t),buildDebugCheckbox(t),buildDebugButton(t),buildOpenSourceLicense(t)}function buildConsoleLog(container){const consoleLogEnable=lsGetItem(lsKeys.consoleLogEnable.id);getById(eleIds.consoleLogInfo,container).style.display=consoleLogEnable?"":"none",consoleLogEnable&&doConsoleLogChange(consoleLogEnable);const consoleLogCtrlEle=getById(eleIds.consoleLogCtrl,container);consoleLogCtrlEle.append(embyCheckbox({label:lsKeys.consoleLogEnable.name},consoleLogEnable,doConsoleLogChange));const consoleLogCountLabel=document.createElement("label");consoleLogCountLabel.id=eleIds.consoleLogCountLabel,consoleLogCtrlEle.append(embyButton({label:"清空",iconKey:iconKeys.block},(()=>{getById(eleIds.consoleLogText,container).value="",getById(eleIds.consoleLogCountLabel).innerHTML="",window.ede.appLogAspect&&(window.ede.appLogAspect.value="")})),consoleLogCountLabel);const consoleLogTextInput=getById(eleIds.consoleLogTextInput,container);consoleLogTextInput.style.display=consoleLogEnable&&lsGetItem(lsKeys.quickDebugOn.id)?"":"none",consoleLogTextInput.addEventListener("keydown",(e=>{if("Enter"===e.key&&!e.shiftKey){e.preventDefault();const inputVal=e.target.value.trim();console.log("输入内容为: \n",inputVal),eval(inputVal),e.target.value=""}}))}function buildDebugCheckbox(e){const t=getById(eleIds.debugCheckbox,e);t.append(embyCheckbox({label:lsKeys.debugShowDanmakuWrapper.name},lsGetItem(lsKeys.debugShowDanmakuWrapper.id),(e=>{lsSetItem(lsKeys.debugShowDanmakuWrapper.id,e);const t=getById(eleIds.danmakuWrapper);if(t.style.backgroundColor=e?styles.colors.highlight:"",!e)return;console.log(`弹幕容器(#${eleIds.danmakuWrapper})宽高像素:`,t.offsetWidth,t.offsetHeight);const n=t.firstChild;console.log(`实际舞台(${n.tagName})宽高像素:`,n.offsetWidth,n.offsetHeight)}))),t.append(embyCheckbox({label:lsKeys.debugShowDanmakuCtrWrapper.name},lsGetItem(lsKeys.debugShowDanmakuCtrWrapper.id),(e=>{lsSetItem(lsKeys.debugShowDanmakuCtrWrapper.id,e);const t=getById(eleIds.danmakuCtr);t.style.backgroundColor=e?styles.colors.highlight:"",e&&console.log(`按钮容器(#${eleIds.danmakuCtr})宽高像素:`,t.offsetWidth,t.offsetHeight)}))),t.append(embyCheckbox({label:lsKeys.debugReverseDanmu.name},lsGetItem(lsKeys.debugReverseDanmu.id),(e=>{lsSetItem(lsKeys.debugReverseDanmu.id,e);const t=window.ede.danmuCache[window.ede.episode_info.episodeId];t.map((e=>{const t=e.p.split(",");t[1]={6:"1",1:"6",5:"4",4:"5"}[t[1]],e.p=t.join()})),console.log("已"+lsKeys.debugReverseDanmu.name),createDanmaku(t)})));const n=(e,t,n)=>{lsSetItem(t.id,e);let i=window.ede.danmuCache[window.ede.episode_info.episodeId];e?(window.ede._oriComments=structuredClone(i),i=i.map((e=>{const t=e.p.split(",");return t[2]=n(),{...e,p:t.join()}})),console.log("已"+t.name)):(i=window.ede._oriComments,window.ede.danmuCache[window.ede.episode_info.episodeId]=i,console.log("已还原"+t.name)),createDanmaku(i)};t.append(embyCheckbox({label:lsKeys.debugRandomDanmuColor.name},lsGetItem(lsKeys.debugRandomDanmuColor.id),(e=>{n(e,lsKeys.debugRandomDanmuColor,(()=>parseInt(Math.floor(16777215*Math.random()).toString(16).padStart(6,"0"),16)))}))),t.append(embyCheckbox({label:lsKeys.debugForceDanmuWhite.name},lsGetItem(lsKeys.debugForceDanmuWhite.id),(e=>{n(e,lsKeys.debugForceDanmuWhite,(()=>parseInt(styles.colors.info.toString(16).padStart(6,"0"),16)))})));const i=document.querySelector("."+classes.dialogContainer),a=i.firstChild;let s=i.classList.contains(classes.dialogBackdropOpened),l=a.classList.contains(classes.dialogBlur);const o=e=>{lsSetItem(lsKeys.debugDialogHyalinize.id,e),e?(a.classList.remove(classes.dialog),s&&i.classList.remove(classes.dialogBackdropOpened),l&&a.classList.remove(classes.dialogBlur)):(a.classList.add(classes.dialog),s&&i.classList.add(classes.dialogBackdropOpened),l&&a.classList.add(classes.dialogBlur))},d=lsGetItem(lsKeys.debugDialogHyalinize.id);o(d),t.append(embyCheckbox({label:lsKeys.debugDialogHyalinize.name},d,o)),lsGetItem(lsKeys.quickDebugOn.id)&&t.append(embyCheckbox({label:lsKeys.debugTabIframeEnable.name},lsGetItem(lsKeys.debugTabIframeEnable.id),(e=>{lsSetItem(lsKeys.debugTabIframeEnable.id,e),getById(tabIframeId+"Btn").style.display=e?"":"none"})))}function buildDebugButton(e){const t=getById(eleIds.debugButton,e);t.append(embyButton({label:"打印弹幕引擎信息"},(()=>{const e=`弹幕引擎是否存在: ${!!window.Danmaku}, 弹幕引擎是否实例化成功: ${!!window.ede.danmaku}`;console.log(e),embyToast({text:e})}))),t.append(embyButton({label:"打印视频加载方"},(()=>{const e=document.querySelector(mediaQueryStr);if(!e)return console.error("严重错误,页面中依旧不存在 <video> 标签");if(e.currentTime<1&&console.error("严重错误,<video> 的 currentTime < 1"),e.id){console.log("当前 <video> 标签为虚拟适配器:",e.outerHTML);const t=document.querySelector("embed");t?console.log("视频加载方为 <embed> 标签占位的 Native 播放器:",t.parentNode.outerHTML):console.log("视频加载方为无占位标签的 Native 播放器,无信息")}else console.log("视频加载方为 Web 端 <video> 标签:",e.parentNode.outerHTML)}))),t.append(embyButton({label:"清空章节引用缓存",class:classes.embyButtons.submit},(()=>{lsBatchRemove(["_episode_id_rel_","_bangumi_episode_id_rel_"]),console.log("已清空章节引用缓存"),embyToast({text:"已清空章节引用缓存"})}))),t.append(embyButton({label:"重置设置",class:classes.embyButtons.submit},(()=>{settingsReset(),console.log(`已重置设置, 跳过了 ${lsKeys.filterKeywords.name} 重置`),embyToast({text:`已重置设置, 跳过了 ${lsKeys.filterKeywords.name} 重置`}),loadDanmaku(LOAD_TYPE.INIT),closeEmbyDialog()})))}function buildOpenSourceLicense(e){const t=getById(eleIds.openSourceLicenseDiv,e);Object.entries(openSourceLicense).map((([e,n])=>{t.append(embyALink(n.url,[e,n.name,n.version,n.license].join(" : ")))}))}function buildIframe(e){const t=getById(e),n=`\n            <div>\n                <div class="${classes.embyFieldDesc}">注意内嵌网页不支持控制器输入,且被禁止内嵌(CSP)的网页无法显示,且跨域无法登录</div>\n                <div style="${styles.embySlider+"margin: 0.8em 0;"}">\n                    <label class="${classes.embyLabel}" style="width: 5em;">网页高度: </label>\n                    <div id="${eleIds.tabIframeHeightDiv}" style="width: 40.5em; text-align: center;"></div>\n                    <label><label id="${eleIds.tabIframeHeightLabel}" style="width:4em;"></label>\n                    <label>em</label></label>\n                </div>\n                <div id="${eleIds.tabIframeCtrlDiv}"></div>\n                <div id="${eleIds.tabIframeSrcInputDiv}" style="display: flex; margin-top: 0.6em;"></div>\n                <iframe id="${eleIds.tabIframe}" style="border: 0;width: 100%;" src=""></iframe>\n            </div>\n        `;t.innerHTML=n.trim(),getById(eleIds.tabIframeHeightDiv,t).append(embySlider({labelId:eleIds.tabIframeHeightLabel},{value:"29",min:28,max:100,step:1},null,((e,t)=>{"28"===e&&(e="auto"),onSliderChangeLabel(e,t),getById(eleIds.tabIframe).style.height="auto"===e?e:e+"em"}))),getById(eleIds.tabIframeSrcInputDiv,t).append(embyInput({type:"search",value:window.ede.bangumiInfo?.bangumiUrl??""},(e=>{getById(eleIds.tabIframe).src=e.target.value.trim()})))}function appendvideoOsdDanmakuInfo(e){if(!lsGetItem(lsKeys.osdTitleEnable.id))return;const{episodeId:t,animeTitle:n,episodeTitle:i}=window.ede?.episode_info||{},a=document.querySelector(`${mediaContainerQueryStr} .videoOsdSecondaryText`);let s=getById(eleIds.videoOsdDanmakuTitle,a);s||(s=document.createElement("h3"),s.id=eleIds.videoOsdDanmakuTitle,s.classList.add(classes.videoOsdTitle),s.style="margin-left: auto; white-space: pre-wrap; word-break: break-word; overflow-wrap: break-word; position: absolute; right: 0px; bottom: 0px;");let l="弹幕：";l+=t?`${n} - ${i} - ${e}条`:"未匹配",s.innerText=l,a&&a.append(s)}function toggleSettingBtn2Header(){const e=getById(eleIds.danmakuSettingBtnDebug);if(e)return e.remove(),!1;const t=mediaBtnOpts[1];return t.id=eleIds.danmakuSettingBtnDebug,getByClass(classes.headerRight).prepend(embyButton(t,t.onClick)),!0}function quickDebug(){const e=toggleSettingBtn2Header();embyToast({text:`${lsKeys.quickDebugOn.name}: ${e}!`}),window.ede||(window.ede=new EDE),lsSetItem(lsKeys.quickDebugOn.id,e),checkRuntimeVars()}function checkRuntimeVars(e=!0){console.log("运行时变量检查"),console.log(lsKeys.customeCorsProxyUrl.name,corsProxy),console.log(lsKeys.customeDanmakuUrl.name,requireDanmakuPath),console.log("弹弹 play API 模板",dandanplayApi),e&&(window.checkRuntimeVars=checkRuntimeVars)}function doDanmakuSwitch(){console.log("切换"+lsKeys.switch.name);const e=!lsGetItem(lsKeys.switch.id);e?window.ede.danmaku?.show():window.ede.danmaku?.hide();const t=getById(eleIds.danmakuSwitchBtn);t&&(t.firstChild.innerHTML=e?iconKeys.comment:iconKeys.comments_disabled);const n=getById(eleIds.danmakuSwitch);n&&(n.firstChild.innerHTML=e?iconKeys.switch_on:iconKeys.switch_off,n.style.color=e?styles.colors.switchActiveColor:""),lsSetItem(lsKeys.switch.id,e)}async function doDanmakuSearchEpisode(){let e=getById(eleIds.danmakuSearchName);if(!e)return;let t=e.value;const n=getById(eleIds.danmakuRemark);n.parentNode.hidden=!1,n.innerText=t?"":"请填写标题";const i=getByClass(classes.mdlSpinner);i.classList.remove("hide");const a=await fetchSearchEpisodes(t);if(i.classList.add("hide"),!a||a.animes.length<1)return n.innerText="搜索结果为空",getById(eleIds.danmakuSwitchEpisode).disabled=!0,void(getById(eleIds.danmakuEpisodeFlag).hidden=!0);n.innerText="";const s=getById(eleIds.danmakuAnimeDiv),l=getById(eleIds.danmakuEpisodeNumDiv);s.innerHTML="",l.innerHTML="";const o=a.animes;window.ede.searchDanmakuOpts.animes=o;let d=o.findIndex((e=>e.animeId==window.ede.searchDanmakuOpts.animeId));d=-1!==d?d:0;const r=embySelect({id:eleIds.danmakuAnimeSelect,label:"剧集: ",style:"width: auto;max-width: 100%;"},d,o,"animeId",(e=>`${e.animeTitle} 类型：${e.typeDescription}`),doDanmakuAnimeSelect);s.append(r);const m=embySelect({id:eleIds.danmakuEpisodeNumSelect,label:"集数: ",style:"width: auto;max-width: 100%;"},window.ede.searchDanmakuOpts.episode,o[d].episodes,"episodeId","episodeTitle");l.append(m),getById(eleIds.danmakuEpisodeFlag).hidden=!1,getById(eleIds.danmakuSwitchEpisode).disabled=!1,getById(eleIds.searchImg).src=dandanplayApi.posterImg(o[d].animeId)}function doSearchTitleSwtich(e){const t=getById(eleIds.danmakuSearchName),n="isOriginalTitle";if("1"===e.target.getAttribute(n))return e.target.setAttribute(n,"0"),t.value=window.ede.searchDanmakuOpts.animeName;const{_episode_key:i,seriesOrMovieId:a}=window.ede.searchDanmakuOpts,s=JSON.parse(localStorage.getItem(i)),{animeOriginalTitle:l}=s;if(l)return e.target.setAttribute(n,"1"),t.value=l;ApiClient.getItem(ApiClient.getCurrentUserId(),a).then((a=>{a.OriginalTitle&&(e.target.setAttribute(n,"1"),t.value=a.OriginalTitle,s.animeOriginalTitle=a.OriginalTitle,localStorage.setItem(i,JSON.stringify(s)),window.ede.episode_info.animeOriginalTitle=a.OriginalTitle)}))}function doDanmakuAnimeSelect(e,t,n){const i=getById(eleIds.danmakuEpisodeNumDiv);i.innerHTML="";const a=window.ede.searchDanmakuOpts.animes[t],s=embySelect({id:eleIds.danmakuEpisodeNumSelect,label:"集数: "},t,a.episodes,"episodeId","episodeTitle");s.style.maxWidth="100%",i.append(s),getById(eleIds.searchImg).src=dandanplayApi.posterImg(a.animeId)}function doDanmakuSwitchEpisode(){const e=getById(eleIds.danmakuAnimeSelect),t=getById(eleIds.danmakuEpisodeNumSelect),n=window.ede.searchDanmakuOpts.animes[e.selectedIndex],i={episodeId:t.value,episodeTitle:t.options[t.selectedIndex].text,episodeIndex:t.selectedIndex,animeId:n.animeId,animeTitle:n.animeTitle},a={name:n.animeTitle,episodeOffset:t.selectedIndex-window.ede.searchDanmakuOpts.episode};writeLsSeasonInfo(window.ede.searchDanmakuOpts._season_key,a),localStorage.setItem(window.ede.searchDanmakuOpts._episode_key,JSON.stringify(i)),console.log("手动匹配信息:",i),loadDanmaku(LOAD_TYPE.RELOAD),closeEmbyDialog()}function writeLsSeasonInfo(e,t){let n=localStorage.getItem(e),i=n?JSON.parse(n):[];const a=i.find((e=>e.name===t.name));a?Object.assign(a,t):i.push(t),localStorage.setItem(e,JSON.stringify(i))}function doDanmakuEngineSelect(e){let t=e.id;lsCheckSet(lsKeys.engine.id,t)&&(console.log(`已更改弹幕引擎为: ${t}`),loadDanmaku(LOAD_TYPE.RELOAD))}function doDanmakuChConverChange(e){window.ede.chConvert=e.id,lsSetItem(lsKeys.chConvert.id,window.ede.chConvert),loadDanmaku(LOAD_TYPE.REFRESH),console.log(e.name)}function doDanmuListOptsChange(e,t){const n=getById(eleIds.danmuListText);n.style.display=t==lsKeys.danmuList.defaultValue?"none":"";const i=new Intl.DateTimeFormat("default",{minute:"2-digit",second:"2-digit"}),a=lsGetItem(lsKeys.showSource.id).length>0;n.value=e.onChange(window.ede).map(((e,t)=>`[${t+1}][${i.format(new Date(1e3*e.time))}] : `+(a?e.originalText:e.text)+(e.source?` [${e.source}]`:"")+(e.originalUserId?`[${e.originalUserId}]`:"")+(e.cid?`[${e.cid}]`:"")+`[${e.mode}]`)).join("\n")}function doDanmakuTypeFilterSelect(){const e=Array.from(document.getElementsByName(eleIds.danmakuTypeFilterSelectName)).filter((e=>e.checked)).map((e=>e.value));lsSetItem(lsKeys.typeFilter.id,e),loadDanmaku(LOAD_TYPE.RELOAD);const t=new Map(Object.values(danmakuTypeFilterOpts).map((e=>[e.id,e.name])));console.log(`当前弹幕类型过滤为: ${JSON.stringify(e.map((e=>t.get(e))))}`)}function doDanmakuSourceFilterSelect(){const e=Array.from(document.getElementsByName(eleIds.danmakuSourceFilterSelectName)).filter((e=>e.checked)).map((e=>e.value));lsSetItem(lsKeys.sourceFilter.id,e),loadDanmaku(LOAD_TYPE.RELOAD),console.log(`当前弹幕来源平台过滤为: ${JSON.stringify(e)}`)}function doDanmakuShowSourceSelect(){const e=Array.from(document.getElementsByName(eleIds.danmakuShowSourceSelectName)).filter((e=>e.checked)).map((e=>e.value));lsSetItem(lsKeys.showSource.id,e),loadDanmaku(LOAD_TYPE.RELOAD);const t=new Map(Object.values(showSource).map((e=>[e.id,e.name])));console.log(`当前弹幕显示来源为: ${JSON.stringify(e.map((e=>t.get(e))))}`)}function onSliderChange(e,t,n=!0,i){onSliderChangeLabel(i||e,t),t?.key&&lsCheckSet(t.key,e)&&(console.log(`${t.key} changed to ${e}`),n&&loadDanmaku(LOAD_TYPE.RELOAD))}function onSliderChangeLabel(e,t){t?.labelId&&(getById(t.labelId).innerText=e)}function doDanmakuFilterKeywordsBtnClick(e){const t=e.currentTarget;t&&(t.style="",t.disabled=!0);let n=getById(eleIds.filterKeywordsId).value.trim(),i=getById(eleIds.filterKeywordsEnableId).checked;lsCheckSet(lsKeys.filterKeywordsEnable.id,i),(lsCheckSet(lsKeys.filterKeywords.id,n)||""!==n)&&loadDanmaku(LOAD_TYPE.RELOAD)}function updateFilterKeywordsBtn(e,t,n){const i=lsCheckOld(lsKeys.filterKeywordsEnable.id,t)&&lsCheckOld(lsKeys.filterKeywords.id,n);e.firstChild.innerHTML=i?iconKeys.done_disabled:iconKeys.done,e.disabled=i}function doConsoleLogChange(e){lsSetItem(lsKeys.consoleLogEnable.id,e),getById(eleIds.consoleLogInfo).style.display=e?"":"none";const t=getById(eleIds.consoleLogText);e?(window.ede.appLogAspect||(window.ede.appLogAspect=(new AppLogAspect).init()),t.value=window.ede.appLogAspect.value,window.ede.appLogAspect.on((e=>{if(t.value.length!==e.length){t.value=e,t.scrollTop=t.scrollHeight;const n=getById(eleIds.consoleLogCountLabel);n&&(n.innerHTML=`清空 ${e.split("\n").length-1} 行`)}}))):(t.value="",window.ede.appLogAspect.destroy(),window.ede.appLogAspect=null)}function getById(e,t=document){return t.querySelector(`#${e}`)}function getByClass(e,t=document){return t.querySelector(`.${e}`)}function getTargetInput(e){return"INPUT"===e.target.tagName?e.target:e.target.previousElementSibling}function embyInput(e,t,n){const i=document.createElement("input",{is:"emby-input"});return Object.entries(e).forEach((([e,t])=>{"function"!=typeof t&&i.setAttribute(e,t)})),i.className=classes.embyInput,"function"==typeof t&&i.addEventListener("keydown",(e=>{"Enter"===e.key&&t(e)})),"function"==typeof n&&i.addEventListener("change",n),i.addEventListener("keydown",(e=>{if(("ArrowLeft"===e.key||"ArrowRight"===e.key)&&(0===i.selectionStart&&"ArrowLeft"===e.key||i.selectionEnd===i.value.length&&"ArrowRight"===e.key)){e.stopPropagation(),e.preventDefault();var t={sourceElement:e.target,repeat:e.repeat,originalEvent:e};require(["inputmanager"],(n=>{n.trigger(e.key.replace("Arrow","").toLowerCase(),t)}))}})),i}function embyI(e,t){const n=document.createElement("i");return n.className="md-icon"+(t?" "+t:""),n.style="pointer-events: none;",n.innerHTML=e,n}function embyButton(e,t){const n=document.createElement("button",{is:"emby-button"});return n.setAttribute("type","button"),Object.entries(e).forEach((([e,t])=>{"iconKey"!==e&&"function"!=typeof t&&n.setAttribute(e,t)})),e.iconKey?(n.setAttribute("title",e.label),n.setAttribute("aria-label",e.label),n.innerHTML=embyI(e.iconKey).outerHTML,n.className=classes.embyButtons.iconButton):(n.classList.add(...classes.embyButtons.basic.split(" ")),n.textContent=e.label),"function"==typeof t&&n.addEventListener("click",t),n}function embyTabs(e,t,n,i,a){const s=document.createElement("div",{is:"emby-tabs"});s.setAttribute("data-index","0"),s.className=classes.embyTabsDiv1,s.style.width="fit-content";const l=document.createElement("div");return l.className=classes.embyTabsDiv2,l.style.padding="0.25em",e.forEach(((e,a)=>{const s=getValueOrInvoke(e,n),o=getValueOrInvoke(e,i),d=document.createElement("button");d.id=e.id+"Btn",d.className=`${classes.embyTabsButton}${s==t?" emby-tab-button-active":""}`,d.setAttribute("data-index",a),d.textContent=o,d.style.display=e.hidden?"none":"",l.append(d)})),s.append(l),"function"==typeof a&&s.addEventListener("tabchange",(t=>a(e[t.detail.selectedTabIndex],t.detail.selectedTabIndex))),s}function embySelect(e,t,n,i,a,s){e={class:"emby-select",...e},Number.isInteger(t)||(t=n.indexOf(t));const l=document.createElement("select",{is:"emby-select"});return Object.entries(e).forEach((([e,t])=>{"function"!=typeof t&&l.setAttribute(e,t)})),n.forEach(((e,n)=>{const s=getValueOrInvoke(e,i),o=getValueOrInvoke(e,a),d=document.createElement("option");d.value=s,d.textContent=o,n===t&&(d.selected=!0),l.append(d)})),"function"==typeof s&&l.addEventListener("change",(e=>{s(e.target.value,e.target.selectedIndex,n[e.target.selectedIndex])})),l}function embyCheckboxList(e,t,n,i,a,s=!1){const l=document.createElement("div");return l.setAttribute("class",classes.embyCheckboxList),l.setAttribute("style",s?"":styles.embyCheckboxList),l.setAttribute("id",e),i.forEach((e=>{l.append(embyCheckbox({name:t,label:e.name,value:e.id},n?.indexOf(e.id)>-1,a))})),l}function embyCheckbox({id:e,name:t,label:n,value:i},a=!1,s){const l=document.createElement("label");l.classList.add("emby-checkbox-label"),l.setAttribute("style","width: auto;");const o=document.createElement("input",{is:"emby-checkbox"});o.setAttribute("is","emby-checkbox"),o.setAttribute("type","checkbox"),o.setAttribute("id",e),o.setAttribute("name",t),o.setAttribute("value",i),o.checked=a,o.classList.add("emby-checkbox","chkEnableLiveTvAccess"),"function"==typeof s&&o.addEventListener("change",(e=>s(e.target.checked)));const d=document.createElement("span");return d.setAttribute("class","checkboxLabel"),d.innerHTML=n,l.append(o),l.append(d),l}function embyTextarea(e,t){e={rows:10,styleResize:"vertical",readonly:!1,...e};const n=document.createElement("textarea",{is:"emby-textarea"});return Object.entries(e).forEach((([e,t])=>{"function"!=typeof t&&"readonly"!==e&&"styleResize"!==e&&"value"!==e&&n.setAttribute(e,t)})),n.className="txtOverview emby-textarea",n.readOnly=e.readonly,n.style.resize=e.styleResize,n.value=e.value,"function"==typeof t&&n.addEventListener("blur",t),n}function embySlider(e={},t={},n,i){t={min:.1,max:3,step:.1,orient:"horizontal","data-bubble":!1,"data-hoverthumb":!0,style:"",...t};const a=document.createElement("input",{is:"emby-slider"});return a.setAttribute("type","range"),e.id&&a.setAttribute("id",e.id),Object.entries(t).forEach((([e,t])=>a.setAttribute(e,t))),"function"==typeof n&&a.addEventListener("change",(t=>n(t.target.value,e))),"function"==typeof i&&a.addEventListener("input",(t=>i(t.target.value,e))),t.value&&(a.setValue(t.value),a.dispatchEvent(new Event("input"))),a.addEventListener("keydown",(e=>{const t=a.getAttribute("orient")||"horizontal";("horizontal"!==t||"ArrowLeft"!==e.key&&"ArrowRight"!==e.key)&&("vertical"!==t||"ArrowUp"!==e.key&&"ArrowDown"!==e.key)||e.stopPropagation()})),a}async function embyDialog(e={}){return e={text:"",title:"",timeout:0,html:"",buttons:[],...e},require(["dialog"]).then((t=>t[0]?.(e))).catch((e=>{console.log("点击弹出框外部取消: "+e)}))}function closeEmbyDialog(){getByClass(classes.formDialogFooterItem).dispatchEvent(new Event("click"))}function embyALink(e,t){const n=document.createElement("a");return n.href=e,n.textContent=t??e,n.target="_blank",n.className="button-link button-link-color-inherit button-link-fontweight-inherit emby-button",OS.isMobile()&&n.addEventListener("click",(t=>{t.preventDefault(),navigator.clipboard.writeText(e).then((()=>{console.log("Link copied to clipboard:",e);const t=document.createElement("label");t.textContent="已复制",t.style.color="green",t.style.paddingLeft="0.5em",n.append(t),setTimeout((()=>{n.removeChild(t)}),3e3)}),(e=>{console.error("Failed to copy link:",e)}))})),n}function embyImg(e,t,n,i=!1){const a=document.createElement("img");return a.id=n,a.src=e,a.style=t,a.loading="lazy",a.decoding="async",a.draggable=i,a.className="coveredImage-noScale cardImage",a}function embyImgButton(e,t){const n=document.createElement("button");return n.style=t,n.className="cardContent-button cardImageContainer cardPadder-portrait defaultCardBackground",n.append(e),n.addEventListener("focus",(()=>{n.style.boxShadow="0 0 0 5px green"})),n.addEventListener("blur",(()=>{n.style.boxShadow=""})),n}async function embyAlert(e={}){return e={text:"",title:"",timeout:0,html:"",...e},require(["alert"]).then((t=>t[0]?.(e))).catch((e=>{console.log("点击弹出框外部取消: "+e)}))}async function embyToast(e={}){return e={text:"",secondaryText:"",icon:"",iconStrikeThrough:!1,...e},require(["toast"],(t=>t(e)))}function getValueOrInvoke(e,t){return"function"==typeof t?t(e):e[t]}function getSettingsJson(e=4){return JSON.stringify(Object.fromEntries(Object.entries(lsKeys).map((([e,t])=>[t.id,lsGetItem(t.id)]))),null,e)}function settingsReset(){lsBatchSet(Object.fromEntries(Object.entries(lsKeys).filter((([e,t])=>lsKeys.filterKeywords.id!==t.id)).map((([e,t])=>[t.id,t.defaultValue]))))}function lsGetItem(e){const t=lsGetKeyById(e);if(!t)return null;const n=lsKeys[t].defaultValue,i=localStorage.getItem(e);return null===i?n:Array.isArray(n)||Array.isArray(n)||"object"==typeof n?JSON.parse(i):"boolean"==typeof n?"true"===i:"number"==typeof n?parseFloat(i):i}function lsCheckOld(e,t){return JSON.stringify(lsGetItem(e))===JSON.stringify(t)}function lsCheckSet(e,t){return!lsCheckOld(e,t)&&(lsSetItem(e,t),!0)}function lsBatchSet(e,t=!0){if(t)return Object.entries(e).reduce(((e,[t,n])=>e||lsCheckSet(t,n)),!1);Object.entries(e).forEach((([e,t])=>lsSetItem(e,t)))}function lsSetItem(e,t){if(!lsGetKeyById(e))return;let n;n=Array.isArray(t)||"object"==typeof t?JSON.stringify(t):t,localStorage.setItem(e,n)}function lsGetKeyById(e){return Object.keys(lsKeys).find((t=>lsKeys[t].id===e))}function lsBatchRemove(e){return Object.keys(localStorage).filter((t=>e.some((e=>t.startsWith(e))))).map((e=>localStorage.removeItem(e))).length>0}function waitForElement(e,t,n=1e4,i=check_interval){let a=null,s=null;a=setInterval((function(){console.log(`waitForElement: checking element[${e}]`);const n=document.querySelector(e);n&&(clearInterval(a),clearTimeout(s),t(n))}),i),window.ede.destroyIntervalIds.push(a),n>0&&(s=setTimeout((()=>{clearInterval(a),console.log(`waitForElement: unable to find element[${e}], timeout: ${n}`)}),n))}function addEasterEggListener(){const e=getByClass(classes.headerUserButton);if(!e)return;let t;function n(){t=setTimeout((()=>{console.log("恭喜你发现了隐藏功能, 长按了 2 秒!"),quickDebug()}),2e3)}function i(){clearTimeout(t)}const a=OS.isMobile(),s=a?"touchstart":"mousedown",l=a?"touchend":"mouseup";return"1"!==e.getAttribute("startFlag")&&(e.addEventListener(s,n),e.setAttribute("startFlag","1")),"1"!==e.getAttribute("endFlag")&&(e.addEventListener(l,i),e.setAttribute("endFlag","1")),()=>{e.removeEventListener(s,n),e.removeEventListener(l,i),clearTimeout(t)}}function initCss(){if(OS.isEmbyNoisyX()){if(!document.querySelector("style[css-emby-noisyx-fix]")){const e=document.createElement("style");e.setAttribute("css-emby-noisyx-fix",""),e.innerHTML='\n                    [class*="accent-"].noScrollY.transparentDocument .toast-group {\n                        position: fixed;\n                        top: auto;\n                    }\n                ',document.head.appendChild(e)}}}async function playbackEventsOn(e){const[t,n]=await require(["playbackManager","events"]),i=t.getCurrentPlayer();i&&Object.entries(e).forEach((([e,t])=>{n.off(i,e,t),n.on(i,e,t)}))}function initH5VideoAdapter(){let e=document.querySelector(mediaQueryStr);e?e.id&&videoTimeUpdateInterval(e,!0):(console.log("播放页不存在 video 标签,适配器处理开始"),e=document.createElement("video"),OS.isApple()&&(e.src=""),e.style.display="none",e.id=eleIds.h5VideoAdapter,e.classList.add("htmlvideoplayer","moveUpSubtitles"),document.body.prepend(e),e.play(),videoTimeUpdateInterval(e,!0),require(["playbackManager"],(t=>{playbackEventsOn({timeupdate:n=>{const i=t.currentTime(t.getCurrentPlayer())/1e7,a=e.currentTime;e.currentTime=i,e.playbackRate=t.getPlayerState().PlayState.PlaybackRate??1,Math.abs(a-i)>2&&(e.dispatchEvent(new Event("seeking")),console.warn("seeking",i,a))}})})),playbackEventsOn({pause:t=>{console.warn(t.type),e.dispatchEvent(new Event("pause")),videoTimeUpdateInterval(e,!1)},unpause:t=>{console.warn(t.type),e.dispatchEvent(new Event("play")),videoTimeUpdateInterval(e,!0)}}),console.log("已创建虚拟 video 标签,适配器处理正确结束"))}function videoTimeUpdateInterval(e,t){const n=e||document.querySelector(mediaQueryStr);n&&(t&&!n.timeupdateIntervalId?n.timeupdateIntervalId=setInterval((()=>{n.currentTime+=.1}),100):!t&&n.timeupdateIntervalId&&(clearInterval(n.timeupdateIntervalId),n.timeupdateIntervalId=null))}function beforeDestroy(){window.ede.danmaku?.clear(),getById(eleIds.danmakuCtr)?.remove(),videoTimeUpdateInterval(null,!1),window.ede.destroyIntervalIds.map((e=>clearInterval(e))),window.ede.destroyIntervalIds=[],lsSetItem(lsKeys.timelineOffset.id,lsKeys.timelineOffset.defaultValue)}document.addEventListener("viewshow",(function(e){console.log(e.type,e),customeUrl.init(),lsGetItem(lsKeys.quickDebugOn.id)&&!getById(eleIds.danmakuSettingBtnDebug)&&quickDebug(),addEasterEggListener(),"video-osd"===e.detail.type&&(window.ede||(window.ede=new EDE),!window.ede.appLogAspect&&lsGetItem(lsKeys.consoleLogEnable.id)&&(window.ede.appLogAspect=(new AppLogAspect).init()),initUI(),initH5VideoAdapter(),initListener(),initCss())})),document.addEventListener("viewbeforehide",(e=>"video-osd"===e.detail.type&&beforeDestroy()))})();